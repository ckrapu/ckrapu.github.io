<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Surrogate modeling for SEIR dynamics | Christopher Krapu </title> <meta name="author" content="Christopher Krapu"> <meta name="description" content="Modeling a model, for epidemiology"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%8C%81&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://ckrapu.github.io/blog/2021/creating-an-emulator-for-an-agent-based-model/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Christopher</span> Krapu </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">posts </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link"> search <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Surrogate modeling for SEIR dynamics</h1> <p class="post-meta"> Created in April 05, 2021 </p> <p class="post-tags"> <a href="/blog/2021"> <i class="fa-solid fa-calendar fa-sm"></i> 2021 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Computers are (still) getting faster every year and it is now commonplace to run simulations in seconds that would have required hours’ or days’ worth of compute time in previous generations. That said, we still often come across cases where our computer models are simply too intricate and/or have too many components to run as often and quickly as we would like. In this scenario, we are frequently forced to choose a limited subset of potential scenarios manifest as parameter settings for which we have the resources to run simulations. I’ve written this notebook to show how to use a <em>statistical emulator</em> to help understand how the outputs of a model’s simulations might vary with parameters.</p> <p>This is going to be similar in many ways to the paper written by Kennedy and O’Hagan (2001) which is frequently cited on the subject, though our approach will be simpler in some regards.To start us off, I’ve modified an example of an agent-based model for disease spread on a grid which was written by Damien Farrell on <a href="https://dmnfarrell.github.io/bioinformatics/abm-mesa-python" rel="external nofollow noopener" target="_blank">his personal site</a>. We’re going to write a statistical emulator in PyMC3 and use it to infer likely values for the date of peak infection <em>without</em> running the simulator exhaustively over the entire parameter space.</p> <p><strong>TL;DR</strong>: we run our simulation for a few combinations of parameter settings and then try to estimate a simulation summary statistic for the entire parameter space.</p> <p>If you’re interested in reproducing this notebook, you can find the <code class="language-plaintext highlighter-rouge">abm_lib.py</code> file at <a href="https://gist.github.com/ckrapu/e2fb8692972ec2b499a1494760ff626e" rel="external nofollow noopener" target="_blank">this gist</a>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">abm_lib</span> <span class="kn">import</span> <span class="n">SIR</span>

</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="o">%</span><span class="n">config</span> <span class="n">InlineBackend</span><span class="p">.</span><span class="n">figure_format</span> <span class="o">=</span> <span class="sh">'</span><span class="s">retina</span><span class="sh">'</span>
</code></pre></div></div> <h2 id="simulating-with-an-abm">Simulating with an ABM</h2> <p>We’ll first need to specify the parameters for the SIR model. This model is fairly rudimentary and is parameterized by:</p> <ul> <li>The number of agents in the simulation</li> <li>The height and width of the spatial grid</li> <li>The proportion of infected agents at the beginng</li> <li>Probability of infecting other agents in the same grid cell</li> <li>Probability of dying from the infection</li> <li>Mean + standard deviation of time required to overcome the infection and recover</li> </ul> <p>These parameters, as well as the number of timesteps in the simulation, are all specified in the following cells. I am going to let most of the parameters be fixed as single values - only two parameters will be allowed to vary in our simulations.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fixed_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">N</span><span class="sh">"</span><span class="p">:</span><span class="mi">20000</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">width</span><span class="sh">"</span><span class="p">:</span><span class="mi">80</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">height</span><span class="sh">"</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">recovery_sd</span><span class="sh">"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">recovery_days</span><span class="sh">"</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">p_infected_initial</span><span class="sh">"</span><span class="p">:</span><span class="mf">0.0002</span>
<span class="p">}</span>
</code></pre></div></div> <p>For the probability of transmission and death rate, we’ll randomly sample some values from the domains indicated below.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sample_bounds</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">ptrans</span><span class="sh">"</span><span class="p">:[</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">death_rate</span><span class="sh">"</span><span class="p">:[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
<span class="p">}</span>
</code></pre></div></div> <p>Here, we iteratively sample new values of the parameters and run the simulation. Since each one takes ~40 seconds, it would take too long to run the simulation at every single parameter value in a dense grid of 1000 or more possible settings.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="n">n_samples_init</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">input_dicts</span>    <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n_samples_init</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">fixed_params</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">sample_bounds</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">v</span><span class="p">)</span>
    <span class="n">input_dicts</span> <span class="o">+=</span> <span class="p">[</span><span class="n">d</span><span class="p">]</span>
    

<span class="n">n_steps</span><span class="o">=</span><span class="mi">100</span>

<span class="n">simulations</span> <span class="o">=</span> <span class="p">[</span><span class="nc">SIR</span><span class="p">(</span><span class="n">n_steps</span><span class="p">,</span> <span class="n">model_kwargs</span><span class="o">=</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">input_dicts</span><span class="p">]</span>
<span class="n">all_states</span>  <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">simulations</span><span class="p">]</span>


</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>100%|██████████| 100/100 [00:57&lt;00:00,  1.75it/s]
100%|██████████| 100/100 [00:36&lt;00:00,  2.78it/s]
100%|██████████| 100/100 [00:52&lt;00:00,  1.91it/s]
100%|██████████| 100/100 [00:35&lt;00:00,  2.80it/s]
100%|██████████| 100/100 [00:37&lt;00:00,  2.64it/s]
100%|██████████| 100/100 [00:40&lt;00:00,  2.48it/s]
100%|██████████| 100/100 [00:40&lt;00:00,  2.47it/s]
100%|██████████| 100/100 [00:40&lt;00:00,  2.44it/s]
100%|██████████| 100/100 [00:39&lt;00:00,  2.50it/s]
100%|██████████| 100/100 [00:23&lt;00:00,  4.32it/s]
</code></pre></div></div> <p>Next, we combine all the sampled parameter values into a dataframe. We also add a column for our response variable which presents a summary of the results from the ABM simulation. We’ll use the timestep for which the level of infection was highest as the <code class="language-plaintext highlighter-rouge">worst_day</code> column in the dataframe.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="n">params_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">input_dicts</span><span class="p">)</span>

<span class="c1"># Add column showing the day with the peak infection rate
</span><span class="n">params_df</span><span class="p">[</span><span class="sh">'</span><span class="s">worst_day</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="nf">argmax</span><span class="p">(</span><span class="n">x</span><span class="p">[...,</span><span class="mi">1</span><span class="p">].</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_states</span><span class="p">]</span>
</code></pre></div></div> <p>We can also spit out a few animations to visualize how the model dynamics behave. This can take quite awhile, however.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">matplotlib.gridspec</span> <span class="k">as</span> <span class="n">gridspec</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>

<span class="n">generate_animations</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">figure_directory</span> <span class="o">=</span> <span class="sh">'</span><span class="s">./figures/sir-states/</span><span class="sh">'</span>

<span class="k">if</span> <span class="n">generate_animations</span><span class="p">:</span>
    <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">g</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">b</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">simulations</span><span class="p">):</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">pair</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">tqdm</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">)):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">constrained_layout</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="p">.</span><span class="nc">GridSpec</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="mi">1</span><span class="p">].</span><span class="n">T</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">jet</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">set_axis_off</span><span class="p">()</span>
            <span class="n">divider</span> <span class="o">=</span> <span class="nf">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="p">.</span><span class="nf">append_axes</span><span class="p">(</span><span class="sh">"</span><span class="s">right</span><span class="sh">"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="sh">"</span><span class="s">3%</span><span class="sh">"</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">plt</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Number infected</span><span class="sh">'</span><span class="p">)</span>

            <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">ax2</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">state</span><span class="p">[:,:,:,</span><span class="n">j</span><span class="p">].</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">ax2</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="n">j</span><span class="p">].</span><span class="nf">sum</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">ax2</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Number infected</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">ax2</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Timestep</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">plt</span><span class="p">.</span><span class="nf">savefig</span><span class="p">(</span><span class="n">figure_directory</span><span class="o">+</span><span class="sh">'</span><span class="s">frame_{1}_{0}.jpg</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span> <span class="nf">str</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="nf">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">j</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="sh">'</span><span class="s">tight</span><span class="sh">'</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
            <span class="n">plt</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

        <span class="err">!</span> <span class="n">cd</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">v7k</span><span class="o">/</span><span class="n">Dropbox</span>\ \<span class="p">(</span><span class="n">ORNL</span>\<span class="p">)</span><span class="o">/</span><span class="n">research</span><span class="o">/</span><span class="n">abm</span><span class="o">-</span><span class="n">inference</span><span class="o">/</span><span class="n">figures</span><span class="o">/</span><span class="n">sir</span><span class="o">-</span><span class="n">states</span><span class="o">/</span><span class="p">;</span> <span class="n">convert</span> <span class="o">*</span><span class="p">.</span><span class="n">jpg</span> <span class="n">sir_states</span><span class="p">{</span><span class="n">k</span><span class="p">}.</span><span class="n">gif</span><span class="p">;</span> <span class="n">rm</span> <span class="o">*</span><span class="p">.</span><span class="n">jpg</span>
</code></pre></div></div> <p><img src="/images/sir_states9.gif" alt="gif"> <img src="/images/sir_states.gif" alt="gif"></p> <p>Clearly, the model parameters make a major difference in the rate of spread of the virus. In the lower case, the spread requires over 100 timesteps to infect most of the agents.</p> <p>If we make a plot depicting the date of peak infection as a function of <code class="language-plaintext highlighter-rouge">ptrans</code> and <code class="language-plaintext highlighter-rouge">death_rate</code>, we’ll get something that looks like the picture below. This is a fairly small set of points and the rest of this notebook will focus on interpolating between them in a way which provides quantified uncertainty.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">params_df</span><span class="p">.</span><span class="n">death_rate</span><span class="p">,</span> <span class="n">params_df</span><span class="p">.</span><span class="n">ptrans</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">params_df</span><span class="p">.</span><span class="n">worst_day</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Death rate</span><span class="sh">'</span><span class="p">),</span> <span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Transmission probability</span><span class="sh">'</span><span class="p">),</span> <span class="n">plt</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Day / timestep</span><span class="sh">"</span><span class="p">);</span>
</code></pre></div></div> <p><img src="/images/2021-04-05-spatial-abm-emulator_19_0.png" alt="png"></p> <h2 id="building-a-simplified-gaussian-process-emulator">Building a simplified Gaussian process emulator</h2> <p>Our probabilistic model for interpolating between ABM parameter points is shown below in the next few code cells. We first rescale the parameter points and the response variable to have unit variance. This makes it a little easier to specify reasonable priors for the parameters of our Gaussian process model.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">param_scales</span>  <span class="o">=</span> <span class="n">params_df</span><span class="p">.</span><span class="nf">std</span><span class="p">()</span>
<span class="n">params_df_std</span> <span class="o">=</span> <span class="n">params_df</span> <span class="o">/</span> <span class="n">param_scales</span>

<span class="n">input_vars</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">sample_bounds</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span>
<span class="n">n_inputs</span>   <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">input_vars</span><span class="p">)</span>
</code></pre></div></div> <p>We assume that the mean function of our Gaussian process is a constant, and we use fairly standard priors for the remaining GP parameters. In particular, we use a <code class="language-plaintext highlighter-rouge">Matern52</code> covariance kernel which allows the correlation between values of our response variable to be a function of the Euclidean distance between them.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pymc3</span> <span class="k">as</span> <span class="n">pm</span>

<span class="k">def</span> <span class="nf">sample_emulator_model_basic</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sampler_kwargs</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">target_accept</span><span class="sh">'</span><span class="p">:</span><span class="mf">0.95</span><span class="p">}):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">n_inputs</span> <span class="o">=</span> <span class="n">X</span><span class="p">.</span><span class="n">shape</span>
    
    <span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">emulator_model</span><span class="p">:</span>
        <span class="n">intercept</span>    <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Normal</span><span class="p">(</span><span class="sh">'</span><span class="s">intercept</span><span class="sh">'</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">length_scale</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">HalfNormal</span><span class="p">(</span><span class="sh">'</span><span class="s">length_scale</span><span class="sh">'</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">variance</span>     <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">InverseGamma</span><span class="p">(</span><span class="sh">'</span><span class="s">variance</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        
        <span class="n">cov_func</span>     <span class="o">=</span> <span class="n">variance</span><span class="o">*</span><span class="n">pm</span><span class="p">.</span><span class="n">gp</span><span class="p">.</span><span class="n">cov</span><span class="p">.</span><span class="nc">Matern52</span><span class="p">(</span><span class="n">n_inputs</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="n">length_scale</span><span class="p">)</span>
        <span class="n">mean_func</span>    <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">gp</span><span class="p">.</span><span class="n">mean</span><span class="p">.</span><span class="nc">Constant</span><span class="p">(</span><span class="n">intercept</span><span class="p">)</span>
        
        <span class="n">gp</span>       <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">gp</span><span class="p">.</span><span class="nc">Marginal</span><span class="p">(</span><span class="n">mean_func</span><span class="o">=</span><span class="n">mean_func</span><span class="p">,</span> <span class="n">cov_func</span><span class="o">=</span><span class="n">cov_func</span><span class="p">)</span>
        <span class="n">noise</span>    <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">HalfNormal</span><span class="p">(</span><span class="sh">'</span><span class="s">noise</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nf">marginal_likelihood</span><span class="p">(</span><span class="sh">'</span><span class="s">response</span><span class="sh">'</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">noise</span><span class="p">)</span>
        <span class="n">trace</span>    <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="o">**</span><span class="n">sampler_kwargs</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">trace</span><span class="p">,</span> <span class="n">emulator_model</span><span class="p">,</span> <span class="n">gp</span>
</code></pre></div></div> <p>Fitting the model runs fairly quickly since we have only a handful of observed data points. If we had 1000 or more instead of 10, we might need to use a different flavor of Gaussian process model to accommodate the larger set of data.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">X</span> <span class="o">=</span> <span class="n">params_df_std</span><span class="p">[</span><span class="n">input_vars</span><span class="p">].</span><span class="n">values</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">params_df_std</span><span class="p">[</span><span class="sh">'</span><span class="s">worst_day</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span>

<span class="n">trace</span><span class="p">,</span> <span class="n">emulator_model</span><span class="p">,</span> <span class="n">gp</span> <span class="o">=</span> <span class="nf">sample_emulator_model_basic</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;ipython-input-15-996f43c1af4e&gt;:17: FutureWarning: In v4.0, pm.sample will return an `arviz.InferenceData` object instead of a `MultiTrace` by default. You can pass return_inferencedata=True or return_inferencedata=False to be safe and silence this warning.
  trace    = pm.sample(**sampler_kwargs)
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [noise, variance, length_scale, intercept]
</code></pre></div></div> <div> <style>progress{border:0;background-size:auto}.progress-bar-interrupted,.progress-bar-interrupted::-webkit-progress-bar{background:#f44336}</style> <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress> 100.00% [8000/8000 00:29&lt;00:00 Sampling 4 chains, 0 divergences] </div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 30 seconds.
The number of effective samples is smaller than 25% for some parameters.
</code></pre></div></div> <p>Predicting at new locations is easy too, once we have our fitted model.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Xnew</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">asarray</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">sample_bounds</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_vars</span><span class="p">]))</span>
<span class="n">Xnew</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">asarray</span><span class="p">([</span><span class="n">Xnew</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">ravel</span><span class="p">(),</span> <span class="n">Xnew</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">ravel</span><span class="p">()]).</span><span class="n">T</span> <span class="o">/</span> <span class="n">param_scales</span><span class="p">[</span><span class="n">input_vars</span><span class="p">].</span><span class="n">values</span>

<span class="k">with</span> <span class="n">emulator_model</span><span class="p">:</span>
    <span class="n">pred_mean</span><span class="p">,</span> <span class="n">pred_var</span> <span class="o">=</span> <span class="n">gp</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">Xnew</span><span class="p">,</span> <span class="n">given</span><span class="o">=</span><span class="n">trace</span><span class="p">,</span> <span class="n">diag</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div> <p>The final two cells create plots showing the posterior predictive distribution of the GP over all the values in parameter space for which we have no data. As we can see, it smoothly interpolates between data points.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">Xnew</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Xnew</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">pred_mean</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Death rate</span><span class="sh">'</span><span class="p">),</span> <span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Transmission probability</span><span class="sh">'</span><span class="p">),</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Posterior mean</span><span class="sh">'</span><span class="p">),</span> <span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Posterior mean surface</span><span class="sh">'</span><span class="p">);</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(&lt;matplotlib.colorbar.Colorbar at 0x7fd2c3beb3a0&gt;,
 Text(0.5, 1.0, 'Posterior mean surface'))
</code></pre></div></div> <p><img src="/images/2021-04-05-spatial-abm-emulator_30_1.png" alt="png"></p> <p>We also see that the variance in the predictions grows as we move farther and farther away from observed data points.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">Xnew</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Xnew</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">pred_var</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Death rate</span><span class="sh">'</span><span class="p">),</span> <span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Transmission probability</span><span class="sh">'</span><span class="p">),</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Posterior variance</span><span class="sh">'</span><span class="p">),</span> <span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Posterior variance surface</span><span class="sh">'</span><span class="p">);</span>
</code></pre></div></div> <p><img src="/images/2021-04-05-spatial-abm-emulator_32_0.png" alt="png"></p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/clustering-for-prob-preterm-birth/">Modeling spatial structure in binary data with an H3 hexagonal coordinate system</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/nonparametric-changepoint-model-pymc/">Modeling temporal data with an unknown number of changepoints</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/density-estimation-for-geospatial-imagery-using-autoregressive-models/">Density estimation for geospatial imagery using autoregressive neural models</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/balanced-spatial-partitioning-for-point-data-in-20-lines/">Balanced spatial partitioning for point data in 20 lines</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/fast-local-summary-earth-engine/">Distributed zonal averages for fast geospatial analyses</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Christopher Krapu. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js" integrity="sha256-rjmgmaB99riUNcdlrDtcAiwtLIojSxNyUFdl+Qh+rB4=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?601a2d3465e2a52bec38b600518d5f70"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let theme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===theme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=document.querySelector(".navbar-collapse");e.classList.contains("show")&&e.classList.remove("show"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"about",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-posts",title:"posts",description:"",section:"Navigation",handler:()=>{window.location.href="/blog/"}},{id:"post-modeling-temporal-data-with-an-unknown-number-of-changepoints",title:"Modeling temporal data with an unknown number of changepoints",description:"A nonparametric changepoint model in PyMC",section:"Posts",handler:()=>{window.location.href="/blog/2022/nonparametric-changepoint-model-pymc/"}},{id:"post-distributed-zonal-averages-for-fast-geospatial-analyses",title:"Distributed zonal averages for fast geospatial analyses",description:"Easy local average with Google Earth Engine&#39;s Python API",section:"Posts",handler:()=>{window.location.href="/blog/2022/fast-local-summary-earth-engine/"}},{id:"post-fast-kronecker-matrix-vector-product-with-einsum",title:"Fast Kronecker matrix-vector product with einsum",description:"Easy local average with Google Earth Engine&#39;s Python API",section:"Posts",handler:()=>{window.location.href="/blog/2021/fast-matrix-vector-product-for-structured-matrices/"}},{id:"post-balanced-spatial-partitioning-for-point-data-in-20-lines",title:"Balanced spatial partitioning for point data in 20 lines",description:"Recursively splitting by boxes",section:"Posts",handler:()=>{window.location.href="/blog/2021/balanced-spatial-partitioning-for-point-data-in-20-lines/"}},{id:"post-modeling-spatial-structure-in-binary-data-with-an-h3-hexagonal-coordinate-system",title:"Modeling spatial structure in binary data with an H3 hexagonal coordinate system",description:"Conditional autoregression for 6-adjacent data",section:"Posts",handler:()=>{window.location.href="/blog/2021/clustering-for-prob-preterm-birth/"}},{id:"post-surrogate-modeling-for-seir-dynamics",title:"Surrogate modeling for SEIR dynamics",description:"Modeling a model, for epidemiology",section:"Posts",handler:()=>{window.location.href="/blog/2021/creating-an-emulator-for-an-agent-based-model/"}},{id:"post-density-estimation-for-geospatial-imagery-using-autoregressive-neural-models",title:"Density estimation for geospatial imagery using autoregressive neural models",description:"Conditional autoregression for 6-adjacent data",section:"Posts",handler:()=>{window.location.href="/blog/2020/density-estimation-for-geospatial-imagery-using-autoregressive-models/"}},{id:"post-multivariate-sample-size-for-markov-chains",title:"Multivariate sample size for Markov chains",description:"Assessing effective sample size for multiple variates",section:"Posts",handler:()=>{window.location.href="/blog/2020/multivariate-sample-size-for-markov-chains/"}},{id:"socials-email",title:"Send email",section:"Socials",handler:()=>{window.open("mailto:%63%6B%72%61%70%75@%67%6D%61%69%6C.%63%6F%6D","_blank")}},{id:"socials-github",title:"GitHub",section:"Socials",handler:()=>{window.open("https://github.com/ckrapu","_blank")}},{id:"socials-rss",title:"RSS Feed",section:"Socials",handler:()=>{window.open("/feed.xml","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> </body> </html>