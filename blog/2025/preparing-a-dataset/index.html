<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> To my junior collaborators, this is how I want you to write your research code | Christopher Krapu </title> <meta name="author" content="Christopher Krapu"> <meta name="description" content="Opinionated commentary on making a data cleaning script for research"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%8C%81&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://ckrapu.github.io/blog/2025/preparing-a-dataset/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Christopher</span> Krapu </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">posts </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link"> search <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">To my junior collaborators, this is how I want you to write your research code</h1> <p class="post-meta"> Created in January 15, 2025 </p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p><em>An example notebook for creating a geospatial machine learning dataset with opinionated commentary.</em></p> <p>As a PhD graduate employed in tech, I am well aware of the existing stereotypes of folks with advanced degrees - they aren’t team players, they use poor practices, they’re overly focused on technical aspects, etc. I personally think that my career is an excellent example of all of these.</p> <p>However, I can give you a strong selling point for PhD graduates as candidates in tech (applicable mostly in the USA, where 5 year+ programs are the norm).</p> <p>The point is this: <strong>there is no other structured program on the planet that forces so many smart, motivated people to come back to their terrible old codebase and have to deal with it alone, without any help, and with virtually zero budget</strong>.</p> <p>In the best case scenario, you do a bunch of awesome research, submit it for journals and conferences, and 6-12 months later, you have to dig into it again to address peer review comments. In the worst case, your research gets dragged along for <strong>years</strong> for a variety of reasons including, but not limited to, (1) personal indifference and apathy, (2) slow review cycles, (3) life, death, birth, and all other acts of chance. I have had projects limp along for four or even five years, requiring me to exhume the code, fix all of the broken dependencies, track down any required data artifacts, and get it running again.</p> <p>In this document, I will show you some good practices on building a data cleaning script for an ML project using remotely sensed data of Earth’s surface. In some ways, this kind of work it is easy because image data is nice and Numpy is awesome. In other ways, it sucks <em>massively</em> thanks to the curvature of Earth’s surface and the abundance of ways to trip yourself up working in both flat and curvilinear coordinate systems. We’ll download land cover data, which represents the continental USA as a grid of pixels across roughly 15 classes like forest, grassland, and developed area. We will also overlay this with elevation maps from the NASA’s <a href="https://www.earthdata.nasa.gov/data/instruments/srtm" rel="external nofollow noopener" target="_blank">SRTM data product</a>.</p> <p><strong>Note</strong>: If you want to run the code in this notebook, you’ll need to download the 2021 National Land Cover Dataset from <a href="https://www.mrlc.gov/data/nlcd-2021-land-cover-conus" rel="external nofollow noopener" target="_blank">here</a>.</p> <h1 id="1-imports">1. Imports</h1> <p>You may think this part is trivial, but there are still ways to make your life miserable. Managing package versions in Python is hard, for structural reasons related to the Python ecosystem. The ecosystem’s greatest strength is its diversity, but this is also the cause of a highly fractured landscape of solutions (<code class="language-plaintext highlighter-rouge">pip</code>, <code class="language-plaintext highlighter-rouge">conda</code>, <code class="language-plaintext highlighter-rouge">uv</code>, <code class="language-plaintext highlighter-rouge">poetry</code>, to name a few).</p> <table> <tbody> <tr> <td>Here’s an idea I will bring up repeatedly in this notebook: your goal is maximize $$P(rerunnable</td> <td>age)\(where\)age$$ itself is an unbounded positive variable. With this in mind, note the following:</td> </tr> </tbody> </table> <ul> <li> <p>Just use <code class="language-plaintext highlighter-rouge">pip</code> with a virtual environment. You can use a fancy, richly-featured package manager like Poetry. This will make you look like a smart guy when people are looking at your repo. However, be honest with yourself. How likely is it that you are going to be using the same Python tooling in 5 years? My advice is to just use <code class="language-plaintext highlighter-rouge">pip</code> with a virtual environment. It’ll be way slower than <code class="language-plaintext highlighter-rouge">uv</code> and it won’t have as many features as Poetry, but you can be sure that when you dig your code out, you will remember how to do <code class="language-plaintext highlighter-rouge">python -m venv venv &amp;&amp; source venv/bin/activate &amp;&amp; pip install -r requirements</code>. You might not even be working in tech several years out, in which case you will definitely <strong>not</strong> want something fancy and richly-featured for the advanced Python developer</p> </li> <li> <p>Once you are done with the first pass on your project, run <code class="language-plaintext highlighter-rouge">pip freeze | requirements.txt</code> to automatically pin your dependencies. This has one major downside, namely that you cannot figure out which packages are essential just by looking at the requirements file. If you decide you want to upgrade your code with a nice few feature, you will have to figure out which packages need to be unpinned. Here’s what I would do: after running pip freeze, pass the whole thing to ChatGPT along with your imports and tell it to filter out any modules that aren’t directly imported by your code.</p> </li> </ul> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">import</span> <span class="n">elevation</span>
<span class="kn">import</span> <span class="n">geopandas</span> <span class="k">as</span> <span class="n">gpd</span>
<span class="kn">import</span> <span class="n">logging</span>
<span class="kn">import</span> <span class="n">matplotlib.patches</span> <span class="k">as</span> <span class="n">mpatches</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">psutil</span>
<span class="kn">import</span> <span class="n">rasterio</span>

<span class="kn">from</span> <span class="n">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="n">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">pyproj</span> <span class="kn">import</span> <span class="n">CRS</span><span class="p">,</span> <span class="n">Transformer</span>
<span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">mode</span>
<span class="kn">from</span> <span class="n">shapely.geometry</span> <span class="kn">import</span> <span class="n">box</span>
<span class="kn">from</span> <span class="n">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>

<span class="o">%</span><span class="n">load_ext</span> <span class="n">watermark</span>
<span class="o">%</span><span class="n">watermark</span> <span class="o">-</span><span class="n">iv</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>matplotlib: 3.9.2
pandas    : 2.2.3
tqdm      : 4.66.5
elevation : 1.1.3
pyproj    : 3.7.0
geopandas : 0.13.2
logging   : 0.5.1.2
cv2       : 4.10.0
numpy     : 1.26.4
scipy     : 1.14.1
rasterio  : 1.3.11
shapely   : 2.0.6
psutil    : 6.1.0
</code></pre></div></div> <h1 id="2-setting-up-the-config">2. Setting up the config</h1> <p>You may want to put your configs in a JSON or a YAML. This is a terrible idea. I’ve tried both and hated both ways. The main issue is that putting the configs in a separate file makes it at least 2x slower to make a change or edit. It also means that you can shoot yourself in the foot by mishandling type conversion / loading. It also subtly encourages you to make bad configuration specs because you don’t have the full set of objects available in standard Python. Some of these types are really quite helpful.</p> <p>Just use a dataclass instead. I especially like using <code class="language-plaintext highlighter-rouge">pathlib</code> to set any file paths ahead of time in an easily readable way.</p> <p>Feel free to make this sucker as long as it needs to be. If you’re feeling really paranoid, you can even add validators like shown below.</p> <p>You might think that the validation function here is overkill, and that even the lowest imbecile wouldn’t make the mistake of specifying a set of invalid lat/long coordinates. Just keep in mind that more successful your project is, the more edits you’ll need to make to it to accommodate the more and more grandiose objectives you’ll come up with. Eventually, you will do something dumb. Catch it early and don’t let it propagate into your expensive computation cells later.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">current_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">cwd</span><span class="p">()</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
    <span class="n">logging_level</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">INFO</span>

    <span class="c1"># Data paths
</span>    <span class="n">data_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">current_path</span> <span class="o">/</span> <span class="sh">'</span><span class="s">data</span><span class="sh">'</span>
    <span class="n">nlcd_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="sh">'</span><span class="s">nlcd_2021_land_cover_l48_20230630.img</span><span class="sh">'</span> <span class="c1"># Make sure you have this file before you start
</span>    <span class="n">output_path_train</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="sh">'</span><span class="s">train.npy</span><span class="sh">'</span>
    <span class="n">output_path_test</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="sh">'</span><span class="s">test.npy</span><span class="sh">'</span>
    <span class="n">split_save_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="o">/</span> <span class="sh">"</span><span class="s">split.gpkg</span><span class="sh">"</span>
    
    <span class="c1"># Geographic bounds (WGS84 coordinates)
</span>    <span class="c1"># bbox_west: float = -116.2
</span>    <span class="c1"># bbox_east: float = -106.34
</span>    <span class="c1"># bbox_south: float = 30.9
</span>    <span class="c1"># bbox_north: float = 44.2
</span>    <span class="n">bbox_west</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">119.0</span>
    <span class="n">bbox_east</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">64.0</span>
    <span class="n">bbox_south</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">22.0</span>
    <span class="n">bbox_north</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">49.0</span>


    <span class="c1"># Sampling parameters
</span>    <span class="n">image_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span>  <span class="c1"># Size of output images
</span>    <span class="n">meters_per_raw_pixel</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span>  <span class="c1"># Meters per pixel in the raw data
</span>    <span class="n">downsample_ratio</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Downsampling factor
</span>    <span class="n">max_fraction_reject_class</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span>  <span class="c1"># Maximum fraction of pixels allowed in a reject-eligible class
</span>    <span class="n">area_fraction_test</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span>  <span class="c1"># Fraction of area to reserve for testing
</span>    <span class="n">n_grid_unit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># discrete units in each dimension for gridding the domain into discrete units
</span>    
    <span class="c1"># Processing parameters
</span>    <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">827</span>  <span class="c1"># Random seed for reproducibility
</span>    <span class="n">recompute_counts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c1"># Whether to recompute class counts
</span>    <span class="n">show_plots</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># Whether to display plots
</span>    
    <span class="c1"># CRS parameters
</span>    <span class="n">working_crs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">'</span><span class="s">EPSG:4326</span><span class="sh">'</span>  <span class="c1"># CRS for geographic operations (WGS84)
</span>    
    <span class="n">nlcd_original_classes_for_reject</span> <span class="o">=</span> <span class="p">{</span><span class="mi">11</span><span class="p">}</span>
    <span class="n">nlcd_original_unknown_class</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Parameters for DEM processing
</span>    <span class="n">dem_nodata_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span>
    <span class="n">dem_product</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">'</span><span class="s">SRTM1</span><span class="sh">'</span> <span class="c1"># Choices are 'SRTM1' or 'SRTM3', lower resolution
</span>    <span class="n">download_dem</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span> 

    <span class="c1"># Mapping from raw NLCD classes to RGB colors for visualization
</span>    <span class="n">nlcd_to_rgb</span>  <span class="o">=</span> <span class="p">{</span>
            <span class="mi">11</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.278</span><span class="p">,</span> <span class="mf">0.420</span><span class="p">,</span> <span class="mf">0.627</span><span class="p">),</span>
            <span class="mi">12</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.820</span><span class="p">,</span> <span class="mf">0.867</span><span class="p">,</span> <span class="mf">0.976</span><span class="p">),</span>
            <span class="mi">21</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.867</span><span class="p">,</span> <span class="mf">0.788</span><span class="p">,</span> <span class="mf">0.788</span><span class="p">),</span>
            <span class="mi">22</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.847</span><span class="p">,</span> <span class="mf">0.576</span><span class="p">,</span> <span class="mf">0.510</span><span class="p">),</span>
            <span class="mi">23</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.929</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="mi">24</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.667</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="mi">31</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.698</span><span class="p">,</span> <span class="mf">0.678</span><span class="p">,</span> <span class="mf">0.639</span><span class="p">),</span>
            <span class="mi">41</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.408</span><span class="p">,</span> <span class="mf">0.667</span><span class="p">,</span> <span class="mf">0.388</span><span class="p">),</span>
            <span class="mi">42</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.110</span><span class="p">,</span> <span class="mf">0.388</span><span class="p">,</span> <span class="mf">0.188</span><span class="p">),</span>
            <span class="mi">43</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.710</span><span class="p">,</span> <span class="mf">0.788</span><span class="p">,</span> <span class="mf">0.557</span><span class="p">),</span>
            <span class="mi">51</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.647</span><span class="p">,</span> <span class="mf">0.549</span><span class="p">,</span> <span class="mf">0.188</span><span class="p">),</span>
            <span class="mi">52</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.800</span><span class="p">,</span> <span class="mf">0.729</span><span class="p">,</span> <span class="mf">0.486</span><span class="p">),</span>
            <span class="mi">71</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.886</span><span class="p">,</span> <span class="mf">0.886</span><span class="p">,</span> <span class="mf">0.757</span><span class="p">),</span>
            <span class="mi">72</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.788</span><span class="p">,</span> <span class="mf">0.788</span><span class="p">,</span> <span class="mf">0.467</span><span class="p">),</span>
            <span class="mi">73</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.600</span><span class="p">,</span> <span class="mf">0.757</span><span class="p">,</span> <span class="mf">0.278</span><span class="p">),</span>
            <span class="mi">74</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.467</span><span class="p">,</span> <span class="mf">0.678</span><span class="p">,</span> <span class="mf">0.576</span><span class="p">),</span>
            <span class="mi">81</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.859</span><span class="p">,</span> <span class="mf">0.847</span><span class="p">,</span> <span class="mf">0.239</span><span class="p">),</span>
            <span class="mi">82</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.667</span><span class="p">,</span> <span class="mf">0.439</span><span class="p">,</span> <span class="mf">0.157</span><span class="p">),</span>
            <span class="mi">90</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.729</span><span class="p">,</span> <span class="mf">0.847</span><span class="p">,</span> <span class="mf">0.918</span><span class="p">),</span>
            <span class="mi">95</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.439</span><span class="p">,</span> <span class="mf">0.639</span><span class="p">,</span> <span class="mf">0.729</span><span class="p">),</span>  
        <span class="p">}</span>
    <span class="n">nlcd_to_name</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">11</span><span class="p">:</span> <span class="sh">"</span><span class="s">Open Water</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">12</span><span class="p">:</span> <span class="sh">"</span><span class="s">Perennial Ice/Snow</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">21</span><span class="p">:</span> <span class="sh">"</span><span class="s">Developed, Open Space</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">22</span><span class="p">:</span> <span class="sh">"</span><span class="s">Developed, Low Intensity</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">23</span><span class="p">:</span> <span class="sh">"</span><span class="s">Developed, Medium Intensity</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">24</span><span class="p">:</span> <span class="sh">"</span><span class="s">Developed, High Intensity</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">31</span><span class="p">:</span> <span class="sh">"</span><span class="s">Barren Land (Rock/Sand/Clay)</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">41</span><span class="p">:</span> <span class="sh">"</span><span class="s">Deciduous Forest</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">42</span><span class="p">:</span> <span class="sh">"</span><span class="s">Evergreen Forest</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">43</span><span class="p">:</span> <span class="sh">"</span><span class="s">Mixed Forest</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">51</span><span class="p">:</span> <span class="sh">"</span><span class="s">Dwarf Scrub</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">52</span><span class="p">:</span> <span class="sh">"</span><span class="s">Shrub/Scrub</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">71</span><span class="p">:</span> <span class="sh">"</span><span class="s">Grassland/Herbaceous</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">72</span><span class="p">:</span> <span class="sh">"</span><span class="s">Sedge/Herbaceous</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">73</span><span class="p">:</span> <span class="sh">"</span><span class="s">Lichens</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">74</span><span class="p">:</span> <span class="sh">"</span><span class="s">Moss</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">81</span><span class="p">:</span> <span class="sh">"</span><span class="s">Pasture/Hay</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">82</span><span class="p">:</span> <span class="sh">"</span><span class="s">Cultivated Crops</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">90</span><span class="p">:</span> <span class="sh">"</span><span class="s">Woody Wetlands</span><span class="sh">"</span><span class="p">,</span>
        <span class="mi">95</span><span class="p">:</span> <span class="sh">"</span><span class="s">Emergent Herbaceous Wetlands</span><span class="sh">"</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># Validate bbox coordinates
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">bbox_west</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">bbox_east</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Invalid bbox coordinates: bbox_west (</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">bbox_west</span><span class="si">}</span><span class="s">) should be less than bbox_east (</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">bbox_east</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">bbox_south</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">bbox_north</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Invalid bbox coordinates: bbox_south (</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">bbox_south</span><span class="si">}</span><span class="s">) should be less than bbox_north (</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">bbox_north</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># Validate file paths
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">nlcd_path</span><span class="p">.</span><span class="nf">is_file</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">NLCD file not found at </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">nlcd_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">data_dir</span><span class="p">.</span><span class="nf">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nc">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Data directory not found at </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">data_dir</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            

<span class="n">config</span> <span class="o">=</span> <span class="nc">Config</span><span class="p">()</span>

<span class="n">logging</span><span class="p">.</span><span class="nf">basicConfig</span><span class="p">(</span>
    <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">[%(levelname)s] %(message)s</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">level</span><span class="o">=</span><span class="n">config</span><span class="p">.</span><span class="n">logging_level</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">seed</span><span class="p">(</span><span class="mi">827</span><span class="p">)</span>

<span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Setting project data directory to </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">data_dir</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[INFO] Setting project data directory to /mnt/m2ssd/data/Dropbox/research/nlcd-inpaint/generative-land-cover/data
</code></pre></div></div> <p>You should also use <code class="language-plaintext highlighter-rouge">logging</code> extensively with Jupyter notebooks. It’s just as easy as using <code class="language-plaintext highlighter-rouge">print</code>. I like to use <code class="language-plaintext highlighter-rouge">INFO</code> for anything remotely resembling a distinct conceptual step in the pipeline. For any row-level operations, i.e. anything inside a for-loop with more than 5 iterates, I’ll use <code class="language-plaintext highlighter-rouge">DEBUG</code>.</p> <h1 id="3-dataset-information-and-crs-setup">3. Dataset Information and CRS Setup</h1> <p>This is where the true fun begins. With your biggest data files, print out <strong>everything</strong> before you start working. For commonly used Python libraries, ChatGPT and Sonnet are perfectly capable of getting all of the metadata fields you never knew about. See below for an example.</p> <p>When you see a kwarg like <code class="language-plaintext highlighter-rouge">always_xy</code>, you <em>know</em> that someone got really upset at some point.</p> <p>Here’s a piece of advice for any kind of geographic data analysis: if, at any point in time, you do not know with 100% certainty whether an imported module or function is using a (lat,long) or (long,lat) convention for ordering of coordinates, you should just stop, take a deep breath, and read the docs.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Open the NLCD dataset and print basic information
</span><span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">nlcd_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Dataset CRS: </span><span class="si">{</span><span class="n">src</span><span class="p">.</span><span class="n">crs</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Dataset bounds: </span><span class="si">{</span><span class="n">src</span><span class="p">.</span><span class="n">bounds</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Dataset shape: </span><span class="si">{</span><span class="n">src</span><span class="p">.</span><span class="n">shape</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Dataset resolution: </span><span class="si">{</span><span class="n">src</span><span class="p">.</span><span class="n">res</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Dataset transform: </span><span class="si">{</span><span class="n">src</span><span class="p">.</span><span class="n">transform</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># Set up CRS transformers
</span>    <span class="n">data_crs</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">crs</span>
    <span class="n">working_crs</span> <span class="o">=</span> <span class="n">CRS</span><span class="p">.</span><span class="nf">from_string</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">working_crs</span><span class="p">)</span>
    
    <span class="c1"># Create transformers for converting between CRS
</span>    <span class="n">to_working_crs</span> <span class="o">=</span> <span class="n">Transformer</span><span class="p">.</span><span class="nf">from_crs</span><span class="p">(</span><span class="n">data_crs</span><span class="p">,</span> <span class="n">working_crs</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">from_working_crs</span> <span class="o">=</span> <span class="n">Transformer</span><span class="p">.</span><span class="nf">from_crs</span><span class="p">(</span><span class="n">working_crs</span><span class="p">,</span> <span class="n">data_crs</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
    <span class="c1"># Convert dataset bounds to working CRS for validation
</span>    <span class="n">bounds</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">bounds</span>
    <span class="n">ds_left</span><span class="p">,</span> <span class="n">ds_bottom</span> <span class="o">=</span> <span class="n">to_working_crs</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">bounds</span><span class="p">.</span><span class="n">bottom</span><span class="p">)</span>
    <span class="n">ds_right</span><span class="p">,</span> <span class="n">ds_top</span> <span class="o">=</span> <span class="n">to_working_crs</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">bounds</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="n">bounds</span><span class="p">.</span><span class="n">top</span><span class="p">)</span>
    
    
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Bounding box validation:</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Dataset bounds (lon/lat): </span><span class="si">{</span><span class="n">ds_left</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">ds_bottom</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">ds_right</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">ds_top</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Selected bbox (lon/lat): </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">bbox_west</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">bbox_south</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">bbox_east</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">bbox_north</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>    
    <span class="n">samples_x</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">config</span><span class="p">.</span><span class="n">downsample_ratio</span> <span class="o">/</span> <span class="n">config</span><span class="p">.</span><span class="n">image_size</span>
    <span class="n">samples_y</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">config</span><span class="p">.</span><span class="n">downsample_ratio</span> <span class="o">/</span> <span class="n">config</span><span class="p">.</span><span class="n">image_size</span>

    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Maximum number of sampled images from full dataset: </span><span class="si">{</span><span class="n">samples_x</span> <span class="o">*</span> <span class="n">samples_y</span><span class="si">:</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[INFO] Dataset CRS: PROJCS["Albers_Conical_Equal_Area",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Albers_Conic_Equal_Area"],PARAMETER["latitude_of_center",23],PARAMETER["longitude_of_center",-96],PARAMETER["standard_parallel_1",29.5],PARAMETER["standard_parallel_2",45.5],PARAMETER["false_easting",0],PARAMETER["false_northing",0],UNIT["meters",1],AXIS["Easting",EAST],AXIS["Northing",NORTH]]
[INFO] Dataset bounds: BoundingBox(left=-2493045.0, bottom=177285.0, right=2342655.0, top=3310005.0)
[INFO] Dataset shape: (104424, 161190)
[INFO] Dataset resolution: (30.0, 30.0)
[INFO] Dataset transform: | 30.00, 0.00,-2493045.00|
| 0.00,-30.00, 3310005.00|
| 0.00, 0.00, 1.00|
[INFO] 
Bounding box validation:
[INFO] Dataset bounds (lon/lat): -119.7861, 21.7423, -63.6722, 49.1771
[INFO] Selected bbox (lon/lat): -119.0, 22.0, -64.0, 49.0
[INFO] Maximum number of sampled images from full dataset: 2630016
</code></pre></div></div> <h1 id="4-class-counting-and-mapping">4. Class Counting and Mapping</h1> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Function to compute class counts in a block
</span><span class="k">def</span> <span class="nf">compute_block_counts</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">unique</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">dict</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span><span class="n">unique</span><span class="p">,</span> <span class="n">counts</span><span class="p">))</span>

<span class="c1"># Calculate available memory
</span><span class="n">available_memory</span> <span class="o">=</span> <span class="n">psutil</span><span class="p">.</span><span class="nf">virtual_memory</span><span class="p">().</span><span class="n">available</span>
<span class="n">dtype_size</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dtype</span><span class="p">(</span><span class="sh">'</span><span class="s">uint8</span><span class="sh">'</span><span class="p">).</span><span class="n">itemsize</span>
<span class="n">max_elements</span> <span class="o">=</span> <span class="n">available_memory</span> <span class="o">//</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dtype_size</span><span class="p">)</span>  <span class="c1"># Use half of available memory
</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">.</span><span class="n">recompute_counts</span><span class="p">:</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Skipping class counts computation from raster; loading from file</span><span class="sh">"</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">nlcd_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># Convert bbox to pixel coordinates
</span>        <span class="n">bbox_left</span><span class="p">,</span> <span class="n">bbox_bottom</span> <span class="o">=</span> <span class="n">from_working_crs</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">bbox_west</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">bbox_south</span><span class="p">)</span>
        <span class="n">bbox_right</span><span class="p">,</span> <span class="n">bbox_top</span> <span class="o">=</span> <span class="n">from_working_crs</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">bbox_east</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">bbox_north</span><span class="p">)</span>
        
        <span class="c1"># Get pixel bounds
</span>        <span class="n">row_start</span><span class="p">,</span> <span class="n">col_start</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">bbox_left</span><span class="p">,</span> <span class="n">bbox_top</span><span class="p">)</span>
        <span class="n">row_end</span><span class="p">,</span> <span class="n">col_end</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">bbox_right</span><span class="p">,</span> <span class="n">bbox_bottom</span><span class="p">)</span>
        
        <span class="c1"># Ensure correct order
</span>        <span class="n">row_start</span><span class="p">,</span> <span class="n">row_end</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">row_start</span><span class="p">,</span> <span class="n">row_end</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">row_start</span><span class="p">,</span> <span class="n">row_end</span><span class="p">)</span>
        <span class="n">col_start</span><span class="p">,</span> <span class="n">col_end</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">col_start</span><span class="p">,</span> <span class="n">col_end</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">col_start</span><span class="p">,</span> <span class="n">col_end</span><span class="p">)</span>
        
        <span class="c1"># Calculate block size for the bbox region
</span>        <span class="n">bbox_height</span> <span class="o">=</span> <span class="n">row_end</span> <span class="o">-</span> <span class="n">row_start</span>
        <span class="n">bbox_width</span> <span class="o">=</span> <span class="n">col_end</span> <span class="o">-</span> <span class="n">col_start</span>
        <span class="n">total_pixels</span> <span class="o">=</span> <span class="n">bbox_height</span> <span class="o">*</span> <span class="n">bbox_width</span>
        <span class="n">n_blocks</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">total_pixels</span> <span class="o">//</span> <span class="n">max_elements</span><span class="p">)</span>
        <span class="n">block_height</span> <span class="o">=</span> <span class="n">bbox_height</span> <span class="o">//</span> <span class="n">n_blocks</span>
        
        <span class="c1"># Initialize counts dictionary
</span>        <span class="n">total_counts</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Process data in blocks within the bbox
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">tqdm</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="n">row_start</span><span class="p">,</span> <span class="n">row_end</span><span class="p">,</span> <span class="n">block_height</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="sh">'</span><span class="s">Computing class counts</span><span class="sh">'</span><span class="p">):</span>
            <span class="c1"># Read a block of data
</span>            <span class="n">window</span> <span class="o">=</span> <span class="n">rasterio</span><span class="p">.</span><span class="n">windows</span><span class="p">.</span><span class="nc">Window</span><span class="p">(</span>
                <span class="n">col_start</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> 
                <span class="n">col_end</span> <span class="o">-</span> <span class="n">col_start</span><span class="p">,</span>
                <span class="nf">min</span><span class="p">(</span><span class="n">block_height</span><span class="p">,</span> <span class="n">row_end</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
            
            <span class="c1"># Update counts
</span>            <span class="n">block_counts</span> <span class="o">=</span> <span class="nf">compute_block_counts</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">block_counts</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                <span class="n">total_counts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_counts</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">v</span>

    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Unique values present in the bbox: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">total_counts</span><span class="p">)</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">total_counts</span><span class="p">.</span><span class="nf">keys</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Drop the counts which are in class 0 (Unknown)
</span>    <span class="n">_</span> <span class="o">=</span> <span class="n">total_counts</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">nlcd_original_unknown_class</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[INFO] Skipping class counts computation from raster; loading from file
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>

<span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">.</span><span class="n">recompute_counts</span><span class="p">:</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Skipping class counts computation from raster; loading from file</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">classes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_parquet</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">data_dir</span><span class="p">)</span> <span class="o">/</span> <span class="sh">'</span><span class="s">class_distribution.parquet</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">total_counts</span> <span class="o">=</span> <span class="n">classes_df</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">class_value</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_dict</span><span class="p">()</span>
    <span class="n">classes_df</span><span class="p">[</span><span class="sh">'</span><span class="s">RGB</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">classes_df</span><span class="p">[</span><span class="sh">'</span><span class="s">class_value</span><span class="sh">'</span><span class="p">].</span><span class="nf">map</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">nlcd_to_rgb</span><span class="p">)</span>
    
    

<span class="k">else</span><span class="p">:</span>
<span class="c1"># Convert to DataFrame for better visualization
</span>    <span class="n">classes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">([</span>
        <span class="p">{</span><span class="sh">'</span><span class="s">class_value</span><span class="sh">'</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="p">:</span> <span class="n">v</span><span class="p">,</span> <span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="n">config</span><span class="p">.</span><span class="n">nlcd_to_name</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="sh">'</span><span class="s">Unknown</span><span class="sh">'</span><span class="p">)}</span> 
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">total_counts</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span>
    <span class="p">])</span>
    <span class="n">classes_df</span><span class="p">[</span><span class="sh">'</span><span class="s">percentage</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">classes_df</span><span class="p">[</span><span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="p">]</span> <span class="o">/</span> <span class="n">classes_df</span><span class="p">[</span><span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">classes_df</span> <span class="o">=</span> <span class="n">classes_df</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Rename the index (currently unnamed) to "class"
</span>    <span class="n">classes_df</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sh">'</span><span class="s">class</span><span class="sh">'</span>
    <span class="n">classes_df</span> <span class="o">=</span> <span class="n">classes_df</span><span class="p">.</span><span class="nf">sort_index</span><span class="p">()</span>

    <span class="c1"># Load the mapping from original class codes to RGB for plotting and add to the dataframe
</span>    <span class="c1"># We will use these for plotting later
</span>    <span class="n">classes_df</span><span class="p">[</span><span class="sh">'</span><span class="s">RGB</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">classes_df</span><span class="p">[</span><span class="sh">'</span><span class="s">class_value</span><span class="sh">'</span><span class="p">].</span><span class="nf">map</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">nlcd_to_rgb</span><span class="p">)</span>
    <span class="n">classes_df</span><span class="p">.</span><span class="nf">to_parquet</span><span class="p">(</span><span class="nc">Path</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">data_dir</span><span class="p">)</span> <span class="o">/</span> <span class="sh">'</span><span class="s">class_distribution.parquet</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">present_classes</span> <span class="o">=</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">total_counts</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span>

<span class="n">class_mapping</span> <span class="o">=</span> <span class="n">classes_df</span><span class="p">[</span><span class="sh">'</span><span class="s">class_value</span><span class="sh">'</span><span class="p">].</span><span class="nf">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="nf">reset_index</span><span class="p">().</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">class_value</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">index</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_dict</span><span class="p">()</span>
<span class="n">reverse_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">:</span> <span class="n">old_val</span> <span class="k">for</span> <span class="n">old_val</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">class_mapping</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>

<span class="n">palette_series</span> <span class="o">=</span> <span class="n">classes_df</span><span class="p">[</span><span class="sh">'</span><span class="s">RGB</span><span class="sh">'</span><span class="p">]</span>
<span class="n">lut</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">palette_series</span><span class="p">.</span><span class="nf">tolist</span><span class="p">())</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Prepare lookup table for plotting with shape </span><span class="si">{</span><span class="n">lut</span><span class="p">.</span><span class="n">shape</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Print mapping from original classes to zero-based indices
</span><span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Class mapping:</span><span class="sh">"</span><span class="p">)</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="n">class_mapping</span><span class="p">)</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[INFO] Skipping class counts computation from raster; loading from file
[INFO] Prepare lookup table for plotting with shape (16, 3)
[INFO] 
Class mapping:
[INFO] {11: 0, 12: 1, 21: 2, 22: 3, 23: 4, 24: 5, 31: 6, 41: 7, 42: 8, 43: 9, 52: 10, 71: 11, 81: 12, 82: 13, 90: 14, 95: 15}
</code></pre></div></div> <h4 id="creating-a-testtrain-split">Creating a test/train split</h4> <p>For a good analysis, you need to make sure that there is no data leakage from test or validation into training. In a geospatial context, this means that the spatial overlap between the areas used for each split should be zero. Here, we split up the entire domain into grid cells and pick some of them to be test units.</p> <p>If you need to perform some sort of random sampling like for training and test units, just use quasi-Monte Carlo (QMC) via something like the Sobel method. QMC is generally applicable in most cases where you would use Monte Carlo, and you can generally get more visually pleasing pseudorandom assortments of points with it. It also makes you seem smart, which is invaluable in peer review.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">qmc</span>  <span class="c1"># Built into scipy, no extra installation needed
</span>
<span class="c1"># Set up grid for train/test split
</span><span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">nlcd_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="c1"># Create grid cells in working CRS using bbox
</span>    <span class="n">x_edges</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">bbox_west</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">bbox_east</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">n_grid_unit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">y_edges</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">bbox_south</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">bbox_north</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">n_grid_unit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Create grid cell polygons
</span>    <span class="n">grid_cells</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">x_edges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">y_edges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Create polygon in working CRS
</span>            <span class="n">polygon</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">geometry</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                    <span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Polygon</span><span class="sh">'</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">coordinates</span><span class="sh">'</span><span class="p">:</span> <span class="p">[[</span>
                        <span class="p">[</span><span class="n">x_edges</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_edges</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">x_edges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_edges</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">x_edges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_edges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">x_edges</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_edges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]],</span>
                        <span class="p">[</span><span class="n">x_edges</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_edges</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
                    <span class="p">]]</span>
                <span class="p">},</span>
                <span class="sh">'</span><span class="s">properties</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">:</span> <span class="nf">len</span><span class="p">(</span><span class="n">grid_cells</span><span class="p">)}</span>
            <span class="p">}</span>
            <span class="n">grid_cells</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>
    
    <span class="c1"># Create GeoDataFrame in working CRS
</span>    <span class="n">grid_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="n">GeoDataFrame</span><span class="p">.</span><span class="nf">from_features</span><span class="p">(</span><span class="n">grid_cells</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">working_crs</span><span class="p">)</span>
    
    <span class="c1"># Set up Sobol sequence generator
</span>    <span class="n">n_cells</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">grid_gdf</span><span class="p">)</span>
    <span class="n">n_test</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">n_cells</span> <span class="o">*</span> <span class="n">config</span><span class="p">.</span><span class="n">area_fraction_test</span><span class="p">)</span>
    
    <span class="c1"># Generate Sobol sequence and scale to unique grid indices
</span>    <span class="n">sobol_points</span> <span class="o">=</span> <span class="n">qmc</span><span class="p">.</span><span class="nc">Sobol</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">config</span><span class="p">.</span><span class="n">random_seed</span><span class="p">).</span><span class="nf">random</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n_test</span><span class="p">)</span>
    <span class="n">sobol_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">sobol_points</span><span class="p">.</span><span class="nf">flatten</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_cells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">sobol_indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">unique</span><span class="p">(</span><span class="n">sobol_indices</span><span class="p">)</span>
    
    <span class="c1"># If we got fewer unique indices than needed, add random ones
</span>    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sobol_indices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_test</span><span class="p">:</span>
        <span class="n">additional_indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span>
            <span class="n">np</span><span class="p">.</span><span class="nf">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">n_cells</span><span class="p">),</span> <span class="n">sobol_indices</span><span class="p">),</span>
            <span class="n">size</span><span class="o">=</span><span class="n">n_test</span> <span class="o">-</span> <span class="nf">len</span><span class="p">(</span><span class="n">sobol_indices</span><span class="p">),</span>
            <span class="n">replace</span><span class="o">=</span><span class="bp">False</span>
        <span class="p">)</span>
        <span class="n">sobol_indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">([</span><span class="n">sobol_indices</span><span class="p">,</span> <span class="n">additional_indices</span><span class="p">])</span>
    
    <span class="c1"># Assign splits
</span>    <span class="n">grid_gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">split</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">train</span><span class="sh">'</span>
    <span class="n">grid_gdf</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sobol_indices</span><span class="p">,</span> <span class="sh">'</span><span class="s">split</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">test</span><span class="sh">'</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Generated </span><span class="si">{</span><span class="n">n_test</span><span class="si">}</span><span class="s"> test cells out of </span><span class="si">{</span><span class="n">n_cells</span><span class="si">}</span><span class="s"> total cells and saved to grid_gdf</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Save the grid to a GeoPackage file
</span><span class="n">grid_gdf</span><span class="p">.</span><span class="nf">to_file</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">split_save_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="sh">'</span><span class="s">GPKG</span><span class="sh">'</span><span class="p">)</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Saved geodataframe for grid of train/test cells to </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">split_save_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">config</span><span class="p">.</span><span class="n">show_plots</span><span class="p">:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">grid_gdf</span><span class="p">[</span><span class="n">grid_gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">split</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">c</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">grid_gdf</span><span class="p">[</span><span class="n">grid_gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">split</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">m</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_edges</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">y_edges</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">.</span><span class="nf">axhline</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Manually create legend elements
</span>    <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">mpatches</span><span class="p">.</span><span class="nc">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">c</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Train unit</span><span class="sh">'</span><span class="p">),</span>
        <span class="n">mpatches</span><span class="p">.</span><span class="nc">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">m</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Test unit</span><span class="sh">'</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="sh">'</span><span class="s">best</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Train/Test Grid Split</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Longitude</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Latitude</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/mnt/m2ssd/data/Dropbox/research/nlcd-inpaint/.venv/lib/python3.10/site-packages/scipy/stats/_qmc.py:958: UserWarning: The balance properties of Sobol' points require n to be a power of 2.
  sample = self._random(n, workers=workers)
[INFO] Generated 500 test cells out of 2500 total cells and saved to grid_gdf
[INFO] Saved geodataframe for grid of train/test cells to /mnt/m2ssd/data/Dropbox/research/nlcd-inpaint/generative-land-cover/data/split.gpkg
</code></pre></div></div> <p align="center"> <img src="/images/nlcd-dataset/01-preparing-a-dataset_16_1.png" width="65%"> </p> <h1 id="6-sampling-land-cover-images">6. Sampling Land Cover Images</h1> <p>At this point, I start to have controversial opinions.</p> <p>I don’t care if the Jupyter cells are too long. It just doesn’t bother me. I don’t think these functions belong in a separate <code class="language-plaintext highlighter-rouge">.py</code> file. Why? Because I ultimately think that reproducible research should have a linear representation, and anything that messes with this mental map of the whole thing as just a top-to-bottom execution is bad.</p> <p>A corollary to this is that it is most helpful if you can anchor your understanding of a notebook with many long code cells by forming landmark visual outputs or tables that help your brain remember where everything happens. I’m a huge fan of animations for this purpose.</p> <p>Another opinion of mine is that getting cute with optimizing vectorized functions is helpful if you are running your code many times a day, but less so if it’s just a one-time thing. Nested loops are bad form in scientific programming in Python, but I’d rather be able to go back and actually understand what is happening.</p> <p>I can write a way more performant version of the code below using vectorized Numpy functions and liberal usage of Numba’s JIT. I take relish in having done this before.</p> <p>I also know that I am too stupid to be able to quickly refresh myself on how an optimal implementation of this works, six months later. Be brave enough to embrace the limits of your own mind. What you see below is a bit of a local optimum between my impatience with slow code and my deep, deep fear of not remembering how any of this works.</p> <p>There’s another cute thing I could do. If you look closely, you can tell that this code is really just splitting up my spatial domain into adjacent, mutually disjoint rectangular subsets. Much of this could be done by reading a large block of raster and doing <code class="language-plaintext highlighter-rouge">.reshape</code> on it to go from <code class="language-plaintext highlighter-rouge">(10000,10000)</code> to <code class="language-plaintext highlighter-rouge">(1_000_000, 10, 10)</code> or similar dimensions. However, this means that I would need to form the bounding box for each image post-hoc by trying to figure out which coordinates were used by each piece of the image.</p> <p>Again, this is where I know I can make some mistakes leading to nasty, hard-to-pin-down errors later, so I just do the dumb option and let myself sleep at night.</p> <p>Run the slow code and go buy yourself a nice piece of chocolate cake at the grocery store while it finishes.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">downsample_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ratio</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Downsample a patch by taking the mode of each ratio x ratio window.</span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">ratio</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">patch</span>
    
    <span class="c1"># Reshape into blocks of size ratio x ratio
</span>    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">patch</span><span class="p">.</span><span class="n">shape</span>
    <span class="n">new_h</span><span class="p">,</span> <span class="n">new_w</span> <span class="o">=</span> <span class="n">h</span> <span class="o">//</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">w</span> <span class="o">//</span> <span class="n">ratio</span>
    <span class="n">reshaped</span> <span class="o">=</span> <span class="n">patch</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="n">new_h</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">new_w</span><span class="p">,</span> <span class="n">ratio</span><span class="p">)</span>
    
    <span class="c1"># Move the two ratio axes adjacent so each block becomes one dimension
</span>    <span class="c1"># resulting shape: (new_h * new_w, ratio * ratio)
</span>    <span class="n">reshaped</span> <span class="o">=</span> <span class="n">reshaped</span><span class="p">.</span><span class="nf">swapaxes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="n">new_h</span> <span class="o">*</span> <span class="n">new_w</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>
    
    <span class="c1"># mode(..., axis=1) finds the most frequent value in each row
</span>    <span class="n">block_modes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nf">mode</span><span class="p">(</span><span class="n">reshaped</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Reshape back to (new_h, new_w)
</span>    <span class="n">downsampled</span> <span class="o">=</span> <span class="n">block_modes</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="n">new_h</span><span class="p">,</span> <span class="n">new_w</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">downsampled</span>

<span class="k">def</span> <span class="nf">get_pixel_bounds</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">size_pixels</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">slice</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]:</span>
    <span class="sh">"""</span><span class="s">Convert geographic coordinates to pixel bounds for image extraction.</span><span class="sh">"""</span>
    <span class="c1"># Convert from working CRS to data CRS
</span>    <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span> <span class="o">=</span> <span class="n">from_working_crs</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    
    <span class="c1"># Convert to pixel coordinates
</span>    <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">)</span>
    
    <span class="c1"># Calculate pixel bounds
</span>    <span class="n">half_size</span> <span class="o">=</span> <span class="n">size_pixels</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">row_start</span> <span class="o">=</span> <span class="n">row</span> <span class="o">-</span> <span class="n">half_size</span>
    <span class="n">row_end</span> <span class="o">=</span> <span class="n">row</span> <span class="o">+</span> <span class="n">half_size</span>
    <span class="n">col_start</span> <span class="o">=</span> <span class="n">col</span> <span class="o">-</span> <span class="n">half_size</span>
    <span class="n">col_end</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="n">half_size</span>
    
    <span class="nf">return </span><span class="p">(</span><span class="nf">slice</span><span class="p">(</span><span class="n">row_start</span><span class="p">,</span> <span class="n">row_end</span><span class="p">),</span> <span class="nf">slice</span><span class="p">(</span><span class="n">col_start</span><span class="p">,</span> <span class="n">col_end</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">check_overlap</span><span class="p">(</span><span class="n">point_coords</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">image_size_meters</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                 <span class="n">grid_gdf</span><span class="p">:</span> <span class="n">gpd</span><span class="p">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Check if an image centered at point_coords overlaps with the specified split area.</span><span class="sh">"""</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">point_coords</span>
    <span class="n">half_size</span> <span class="o">=</span> <span class="n">image_size_meters</span> <span class="o">/</span> <span class="mi">2</span>
    
    <span class="c1"># Create a box representing the image extent in working CRS
</span>    <span class="n">image_box</span> <span class="o">=</span> <span class="nf">box</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">half_size</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">half_size</span><span class="p">,</span>
                   <span class="n">x</span> <span class="o">+</span> <span class="n">half_size</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">half_size</span><span class="p">)</span>
    
    <span class="c1"># Check intersection with grid cells of the opposite split
</span>    <span class="n">opposite_split</span> <span class="o">=</span> <span class="sh">'</span><span class="s">test</span><span class="sh">'</span> <span class="k">if</span> <span class="n">split</span> <span class="o">==</span> <span class="sh">'</span><span class="s">train</span><span class="sh">'</span> <span class="k">else</span> <span class="sh">'</span><span class="s">train</span><span class="sh">'</span>
    <span class="n">opposite_cells</span> <span class="o">=</span> <span class="n">grid_gdf</span><span class="p">[</span><span class="n">grid_gdf</span><span class="p">[</span><span class="sh">'</span><span class="s">split</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">opposite_split</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="ow">not</span> <span class="nf">any</span><span class="p">(</span><span class="n">image_box</span><span class="p">.</span><span class="nf">intersects</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">opposite_cells</span><span class="p">.</span><span class="n">geometry</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">is_within_bbox</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Check if a point is within the specified bbox.</span><span class="sh">"""</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">bbox_west</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">config</span><span class="p">.</span><span class="n">bbox_east</span> <span class="ow">and</span>
            <span class="n">config</span><span class="p">.</span><span class="n">bbox_south</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="n">config</span><span class="p">.</span><span class="n">bbox_north</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">process_cell</span><span class="p">(</span><span class="n">cell_data</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Process a single cell of data.
    
    Args:
        cell_data: tuple of (cell, src_bounds, src_res, transforms)
        args: dict containing configuration parameters
    </span><span class="sh">"""</span>
    <span class="n">cell</span><span class="p">,</span> <span class="n">src_bounds</span><span class="p">,</span> <span class="n">src_res</span><span class="p">,</span> <span class="n">transforms</span> <span class="o">=</span> <span class="n">cell_data</span>
    <span class="n">to_working_crs</span><span class="p">,</span> <span class="n">from_working_crs</span> <span class="o">=</span> <span class="n">transforms</span>
    
    <span class="c1"># Unpack configuration
</span>    <span class="n">config</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">'</span><span class="s">config</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">class_mapping</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="sh">'</span><span class="s">class_mapping</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">full_size_pixels</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">image_size</span> <span class="o">*</span> <span class="n">config</span><span class="p">.</span><span class="n">downsample_ratio</span>
    
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">cell</span><span class="p">.</span><span class="n">geometry</span><span class="p">.</span><span class="n">bounds</span>
    <span class="n">split</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="sh">'</span><span class="s">split</span><span class="sh">'</span><span class="p">]</span>
    
    <span class="c1"># Convert bounds to pixel coordinates
</span>    <span class="n">bbox_left</span><span class="p">,</span> <span class="n">bbox_bottom</span> <span class="o">=</span> <span class="n">from_working_crs</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">bbox_right</span><span class="p">,</span> <span class="n">bbox_top</span> <span class="o">=</span> <span class="n">from_working_crs</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    
    <span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">nlcd_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">row_start</span><span class="p">,</span> <span class="n">col_start</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">bbox_left</span><span class="p">,</span> <span class="n">bbox_top</span><span class="p">)</span>
        <span class="n">row_end</span><span class="p">,</span> <span class="n">col_end</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">bbox_right</span><span class="p">,</span> <span class="n">bbox_bottom</span><span class="p">)</span>
        
        <span class="c1"># Ensure correct order
</span>        <span class="n">row_start</span><span class="p">,</span> <span class="n">row_end</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">row_start</span><span class="p">,</span> <span class="n">row_end</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">row_start</span><span class="p">,</span> <span class="n">row_end</span><span class="p">)</span>
        <span class="n">col_start</span><span class="p">,</span> <span class="n">col_end</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">col_start</span><span class="p">,</span> <span class="n">col_end</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">col_start</span><span class="p">,</span> <span class="n">col_end</span><span class="p">)</span>
        
        <span class="c1"># Read the entire cell into memory
</span>        <span class="n">cell_data</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">rasterio</span><span class="p">.</span><span class="n">windows</span><span class="p">.</span><span class="nc">Window</span><span class="p">(</span>
            <span class="n">col_start</span><span class="p">,</span> <span class="n">row_start</span><span class="p">,</span> 
            <span class="n">col_end</span> <span class="o">-</span> <span class="n">col_start</span><span class="p">,</span> 
            <span class="n">row_end</span> <span class="o">-</span> <span class="n">row_start</span>
        <span class="p">))</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Extract images from the cell
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cell_data</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">full_size_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">full_size_pixels</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cell_data</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">full_size_pixels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">full_size_pixels</span><span class="p">):</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">cell_data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">full_size_pixels</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span><span class="n">j</span> <span class="o">+</span> <span class="n">full_size_pixels</span><span class="p">]</span>
            
            <span class="c1"># Reject if any pixels are unknown
</span>            <span class="k">if</span> <span class="n">np</span><span class="p">.</span><span class="nf">any</span><span class="p">(</span><span class="n">patch</span> <span class="o">==</span> <span class="n">config</span><span class="p">.</span><span class="n">nlcd_original_unknown_class</span><span class="p">):</span>
                <span class="k">continue</span>
            
            <span class="c1"># Check water fraction
</span>            <span class="n">reject</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">config</span><span class="p">.</span><span class="n">nlcd_original_classes_for_reject</span><span class="p">:</span>
                <span class="n">class_fraction</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">patch</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">class_fraction</span> <span class="o">&gt;</span> <span class="n">config</span><span class="p">.</span><span class="n">max_fraction_reject_class</span><span class="p">:</span>
                    <span class="n">reject</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">reject</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="c1"># Downsample the patch
</span>            <span class="n">downsampled</span> <span class="o">=</span> <span class="nf">downsample_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">downsample_ratio</span><span class="p">)</span>
            
            <span class="c1"># Create a copy for remapping
</span>            <span class="n">remapped</span> <span class="o">=</span> <span class="n">downsampled</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
            <span class="c1"># Remap classes to zero-based indices
</span>            <span class="k">for</span> <span class="n">old_val</span><span class="p">,</span> <span class="n">new_val</span> <span class="ow">in</span> <span class="n">class_mapping</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                <span class="n">remapped</span><span class="p">[</span><span class="n">downsampled</span> <span class="o">==</span> <span class="n">old_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
            
            <span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">nlcd_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">x_ul</span><span class="p">,</span> <span class="n">y_ul</span> <span class="o">=</span> <span class="n">to_working_crs</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">.</span><span class="nf">xy</span><span class="p">(</span><span class="n">row_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">col_start</span> <span class="o">+</span> <span class="n">j</span><span class="p">))</span>
                <span class="n">x_lr</span><span class="p">,</span> <span class="n">y_lr</span> <span class="o">=</span> <span class="n">to_working_crs</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">.</span><span class="nf">xy</span><span class="p">(</span>
                    <span class="n">row_start</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="n">full_size_pixels</span><span class="p">,</span> 
                    <span class="n">col_start</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">full_size_pixels</span>
                <span class="p">))</span>
            
            <span class="n">bbox</span> <span class="o">=</span> <span class="nf">box</span><span class="p">(</span><span class="n">x_ul</span><span class="p">,</span> <span class="n">y_ul</span><span class="p">,</span> <span class="n">x_lr</span><span class="p">,</span> <span class="n">y_lr</span><span class="p">)</span>
            <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">remapped</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">split</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">results</span>

<span class="k">def</span> <span class="nf">sample_images_parallel</span><span class="p">(</span><span class="n">grid_gdf</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">class_mapping</span><span class="p">,</span> <span class="n">n_processes</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Sample and process images in parallel for either train or test set.
    
    Args:
        grid_gdf: GeoDataFrame containing grid cells
        config: Configuration object
        class_mapping: Dictionary mapping old class values to new ones
        n_processes: Number of processes to use (defaults to CPU count - 1)
    
    Returns:
        tuple: (train_images, train_gdf, test_images, test_gdf)
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">n_processes</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">n_processes</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mp</span><span class="p">.</span><span class="nf">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Get source metadata once
</span>    <span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">nlcd_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">src_bounds</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">bounds</span>
        <span class="n">src_res</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">res</span>
    
    <span class="c1"># Prepare arguments for parallel processing
</span>    <span class="n">transforms</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_working_crs</span><span class="p">,</span> <span class="n">from_working_crs</span><span class="p">)</span>  <span class="c1"># Assuming these are defined
</span>    <span class="n">cell_data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">cell</span><span class="p">,</span> <span class="n">src_bounds</span><span class="p">,</span> <span class="n">src_res</span><span class="p">,</span> <span class="n">transforms</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">grid_gdf</span><span class="p">.</span><span class="nf">iterrows</span><span class="p">()]</span>
    
    <span class="c1"># Prepare static arguments
</span>    <span class="n">process_args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">config</span><span class="sh">'</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">class_mapping</span><span class="sh">'</span><span class="p">:</span> <span class="n">class_mapping</span>
    <span class="p">}</span>
    
    <span class="c1"># Create process pool and process cells in parallel
</span>    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Processing cells using </span><span class="si">{</span><span class="n">n_processes</span><span class="si">}</span><span class="s"> processes...</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">mp</span><span class="p">.</span><span class="nc">Pool</span><span class="p">(</span><span class="n">n_processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">process_func</span> <span class="o">=</span> <span class="nf">partial</span><span class="p">(</span><span class="n">process_cell</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">process_args</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">tqdm</span><span class="p">(</span>
            <span class="n">pool</span><span class="p">.</span><span class="nf">imap</span><span class="p">(</span><span class="n">process_func</span><span class="p">,</span> <span class="n">cell_data</span><span class="p">),</span>
            <span class="n">total</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">cell_data</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="sh">"</span><span class="s">Processing grid cells</span><span class="sh">"</span>
        <span class="p">))</span>
    
    <span class="c1"># Flatten results and separate train/test
</span>    <span class="n">train_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">test_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">train_bboxes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">test_bboxes</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">cell_results</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">remapped</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">cell_results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">split</span> <span class="o">==</span> <span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">train_images</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">remapped</span><span class="p">)</span>
                <span class="n">train_bboxes</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test_images</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">remapped</span><span class="p">)</span>
                <span class="n">test_bboxes</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>
    
    <span class="c1"># Create GeoDataFrames for train and test bounding boxes
</span>    <span class="n">working_crs</span> <span class="o">=</span> <span class="n">grid_gdf</span><span class="p">.</span><span class="n">crs</span>  <span class="c1"># Get CRS from input GeoDataFrame
</span>    <span class="n">train_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="nc">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">train_bboxes</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">working_crs</span><span class="p">)</span>
    <span class="n">test_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="nc">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">test_bboxes</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">working_crs</span><span class="p">)</span>
    
    <span class="nf">return </span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">train_images</span><span class="p">),</span> <span class="n">train_gdf</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">test_images</span><span class="p">),</span> <span class="n">test_gdf</span><span class="p">)</span>


<span class="n">train_images</span><span class="p">,</span> <span class="n">train_gdf</span><span class="p">,</span> <span class="n">test_images</span><span class="p">,</span> <span class="n">test_gdf</span> <span class="o">=</span> <span class="nf">sample_images_parallel</span><span class="p">(</span>
    <span class="n">grid_gdf</span><span class="p">,</span>
    <span class="n">config</span><span class="p">,</span>
    <span class="n">class_mapping</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div> <h4 id="data-validation">Data validation</h4> <p>Coding copilots can do autocomplete a dozen of these <code class="language-plaintext highlighter-rouge">assert</code>-type tests in a minute.</p> <p>Just do them. Do as many as you have patience for.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Make sure all images are in the valid integer range with no NaNs
</span><span class="k">assert</span> <span class="n">np</span><span class="p">.</span><span class="nf">all</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">isfinite</span><span class="p">(</span><span class="n">train_images</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">np</span><span class="p">.</span><span class="nf">all</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">isfinite</span><span class="p">(</span><span class="n">test_images</span><span class="p">))</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">All images are free of null / NaN values.</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Make sure in right range of values
</span><span class="k">assert</span> <span class="n">np</span><span class="p">.</span><span class="nf">all</span><span class="p">((</span><span class="n">train_images</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">train_images</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">class_mapping</span><span class="p">))),</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unqiue train values: </span><span class="si">{</span><span class="n">np</span><span class="p">.</span><span class="nf">unique</span><span class="p">(</span><span class="n">train_images</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
<span class="k">assert</span> <span class="n">np</span><span class="p">.</span><span class="nf">all</span><span class="p">((</span><span class="n">test_images</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">test_images</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">class_mapping</span><span class="p">))),</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Unqiue test values: </span><span class="si">{</span><span class="n">np</span><span class="p">.</span><span class="nf">unique</span><span class="p">(</span><span class="n">test_images</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">All images are in the correct range of values.</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Check that the images are the correct size
</span><span class="k">assert</span> <span class="n">train_images</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">image_size</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">image_size</span><span class="p">),</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Train shape: </span><span class="si">{</span><span class="n">train_images</span><span class="p">.</span><span class="n">shape</span><span class="si">}</span><span class="s"> should be </span><span class="si">{</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">image_size</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">image_size</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
<span class="k">assert</span> <span class="n">test_images</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">image_size</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">image_size</span><span class="p">),</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Test shape: </span><span class="si">{</span><span class="n">test_images</span><span class="p">.</span><span class="n">shape</span><span class="si">}</span><span class="s">, should be </span><span class="si">{</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">image_size</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">image_size</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">All images are the correct size.</span><span class="sh">"</span><span class="p">)</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[INFO] All images are free of null / NaN values.
[INFO] All images are in the correct range of values.
[INFO] All images are the correct size.
</code></pre></div></div> <p>More visual representations of your data are better. Here’s the locations of our sampled images so far. It even has a surprise - the west coast is cut off! It turns out this is a limitation of this data file. Good thing we caught it early!</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_gdf</span><span class="p">.</span><span class="nf">plot</span><span class="p">()</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Axes: &gt;
&lt;p align="center"&gt;
    &lt;img src="/images/nlcd-dataset/01-preparing-a-dataset_23_1.png" width="65%"&gt;
&lt;/p&gt;
</code></pre></div></div> <h4 id="plot-sample-images">Plot sample images</h4> <p>Before, I opted out of doing random sampling of my data and instead decided to partition the entire spatial domain.</p> <p>A beautiful side effect of this choice is that I can plot the first <code class="language-plaintext highlighter-rouge">n</code> examples from both train and test splits, and examine to see if they show continuity from one example to the next. This helps me diagnose subtle indexing errors right away. Fortunately, these appear to be correct.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n_images</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">seen_classes</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>

<span class="k">if</span> <span class="n">config</span><span class="p">.</span><span class="n">show_plots</span><span class="p">:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_images</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n_images</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="nf">zip</span><span class="p">([</span><span class="n">train_images</span><span class="p">,</span> <span class="n">test_images</span><span class="p">],</span> <span class="p">[</span><span class="n">train_gdf</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">geometry</span><span class="p">,</span> <span class="n">test_gdf</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">geometry</span><span class="p">],</span> <span class="p">[</span><span class="sh">"</span><span class="s">Train</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Test</span><span class="sh">"</span><span class="p">])):</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">lut</span><span class="p">[</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s"> Image </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>

            <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">geom</span><span class="p">.</span><span class="n">centroid</span><span class="p">.</span><span class="n">xy</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">text</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                          <span class="n">bbox</span><span class="o">=</span><span class="nf">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">white</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="sh">'</span><span class="s">round,pad=0.3</span><span class="sh">'</span><span class="p">))</span>
            <span class="n">seen_classes</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">unique</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="p">.</span><span class="nc">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">classes_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sh">"</span><span class="s">RGB</span><span class="sh">"</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">classes_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">seen_classes</span><span class="p">]</span>

    <span class="n">fig</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="sh">'</span><span class="s">lower center</span><span class="sh">'</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">))</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Skipping display of sample NLCD images. Set `show_plots` to True to display.</span><span class="sh">"</span><span class="p">)</span>

</code></pre></div></div> <p align="center"> <img src="/images/nlcd-dataset/01-preparing-a-dataset_26_0.png" width="65%"> </p> <h1 id="7-class-distribution-across-sampled-images">7. Class distribution across sampled images</h1> <p>Paranoia is healthy. I have no reason to believe that the below code will show any discrepancy between the expected sample proportions and the overall marginal distribution of pixels in the original raster file. Yet, we check anyway.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">compute_class_distribution</span><span class="p">(</span><span class="n">images</span><span class="p">):</span>
    <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">unique</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">counts</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">reverse_mapping</span><span class="p">[</span><span class="n">cls</span><span class="p">]:</span> <span class="n">count</span><span class="o">/</span><span class="n">total</span> <span class="k">for</span> <span class="n">cls</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">unique</span><span class="p">,</span> <span class="n">counts</span><span class="p">)}</span>

<span class="n">train_dist</span> <span class="o">=</span> <span class="nf">compute_class_distribution</span><span class="p">(</span><span class="n">train_images</span><span class="p">)</span>
<span class="n">test_dist</span> <span class="o">=</span> <span class="nf">compute_class_distribution</span><span class="p">(</span><span class="n">test_images</span><span class="p">)</span>

<span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Final class distribution (original class ID: percentage):</span><span class="sh">"</span><span class="p">)</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Training set:</span><span class="sh">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">cls_id</span><span class="p">,</span> <span class="n">pct</span> <span class="ow">in</span> <span class="n">train_dist</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">cls_id</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">nlcd_to_name</span><span class="p">[</span><span class="n">cls_id</span><span class="p">]</span><span class="si">}</span><span class="s">): </span><span class="si">{</span><span class="n">pct</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">%</span><span class="sh">"</span><span class="p">)</span>


</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[INFO] 
Final class distribution (original class ID: percentage):
[INFO] 
Training set:
[INFO] 11 (Open Water): 2.18%
[INFO] 12 (Perennial Ice/Snow): 0.01%
[INFO] 21 (Developed, Open Space): 3.95%
[INFO] 22 (Developed, Low Intensity): 2.00%
[INFO] 23 (Developed, Medium Intensity): 0.99%
[INFO] 24 (Developed, High Intensity): 0.31%
[INFO] 31 (Barren Land (Rock/Sand/Clay)): 0.93%
[INFO] 41 (Deciduous Forest): 11.95%
[INFO] 42 (Evergreen Forest): 10.61%
[INFO] 43 (Mixed Forest): 3.47%
[INFO] 52 (Shrub/Scrub): 19.39%
[INFO] 71 (Grassland/Herbaceous): 12.73%
[INFO] 81 (Pasture/Hay): 7.12%
[INFO] 82 (Cultivated Crops): 17.66%
[INFO] 90 (Woody Wetlands): 5.23%
[INFO] 95 (Emergent Herbaceous Wetlands): 1.48%
</code></pre></div></div> <h1 id="8-downloading-and-matching-with-dem-data">8. Downloading and matching with DEM data</h1> <h4 id="download-data-using-elevation">Download data using <code class="language-plaintext highlighter-rouge">elevation</code> </h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">if</span> <span class="n">config</span><span class="p">.</span><span class="n">download_dem</span><span class="p">:</span>
    <span class="n">n_dem_downloads</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="mi">625</span><span class="p">,</span> <span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">bbox_west</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">bbox_south</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">bbox_east</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">bbox_north</span><span class="p">)</span>  <span class="c1"># should be a square number
</span>    <span class="c1"># Define the bounding box for continental USA (approximate)
</span>    <span class="c1"># For testing, use a sample pair of values like below:
</span>    <span class="c1"># n_dem_downloads, bounds = 4, (-100.0, 28.0, -99.0, 29.0)  # should be a square number
</span>
    <span class="n">dem_dir</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">data_dir</span><span class="p">)</span> <span class="o">/</span> <span class="sh">'</span><span class="s">dem</span><span class="sh">'</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">dem_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Calculate the number of splits in each dimension
</span>    <span class="n">n_splits</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">n_dem_downloads</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Remove all files from the DEM directory
</span>    <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">dem_dir</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="sh">'</span><span class="s">*.tif</span><span class="sh">'</span><span class="p">):</span>
        <span class="nb">file</span><span class="p">.</span><span class="nf">unlink</span><span class="p">()</span>

    <span class="c1"># Split bounds into a grid and download DEM data
</span>    <span class="k">with</span> <span class="nf">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">n_dem_downloads</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sh">"</span><span class="s">Downloading DEM data</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n_splits</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n_splits</span><span class="p">):</span>
                <span class="n">west</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="n">n_splits</span>
                <span class="n">east</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_splits</span>
                <span class="n">south</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">j</span> <span class="o">/</span> <span class="n">n_splits</span>
                <span class="n">north</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_splits</span>

                <span class="k">assert</span> <span class="n">west</span> <span class="o">&lt;</span> <span class="n">east</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">West </span><span class="si">{</span><span class="n">west</span><span class="si">}</span><span class="s"> should be less than east </span><span class="si">{</span><span class="n">east</span><span class="si">}</span><span class="sh">"</span>
                <span class="k">assert</span> <span class="n">south</span> <span class="o">&lt;</span> <span class="n">north</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">South </span><span class="si">{</span><span class="n">south</span><span class="si">}</span><span class="s"> should be less than north </span><span class="si">{</span><span class="n">north</span><span class="si">}</span><span class="sh">"</span>
                
                <span class="n">dem_save_path</span> <span class="o">=</span> <span class="n">dem_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="sh">'</span><span class="s">conus_dem_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s">.tif</span><span class="sh">'</span>
                <span class="n">elevation</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">west</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">north</span><span class="p">),</span> <span class="n">output</span><span class="o">=</span><span class="n">dem_save_path</span><span class="p">,</span> <span class="n">product</span><span class="o">=</span><span class="n">config</span><span class="p">.</span><span class="n">dem_product</span><span class="p">)</span>

                <span class="c1"># Check the statistics on the DEM
</span>                <span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">dem_save_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                    <span class="n">dem_data</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">dem_nodata</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">nodata</span>
                    <span class="n">dem_stats</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="sh">'</span><span class="s">min</span><span class="sh">'</span><span class="p">:</span> <span class="n">dem_data</span><span class="p">.</span><span class="nf">min</span><span class="p">(),</span>
                        <span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">:</span> <span class="n">dem_data</span><span class="p">.</span><span class="nf">max</span><span class="p">(),</span>
                        <span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">:</span> <span class="n">dem_data</span><span class="p">.</span><span class="nf">mean</span><span class="p">(),</span>
                        <span class="sh">'</span><span class="s">nodata</span><span class="sh">'</span><span class="p">:</span> <span class="n">dem_nodata</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">nodata_fraction</span><span class="sh">'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">dem_data</span> <span class="o">==</span> <span class="n">dem_nodata</span><span class="p">)</span>
                    <span class="p">}</span>
                    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">DEM statistics for </span><span class="si">{</span><span class="n">dem_save_path</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">dem_stats</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

                <span class="n">pbar</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Skipping DEM download. Set `download_dem` to True to download.</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <h4 id="merge-into-single-contiguous-dem-raster-file">Merge into single contiguous DEM raster file</h4> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="kn">from</span> <span class="n">rasterio</span> <span class="kn">import</span> <span class="n">merge</span>

<span class="c1"># Create a list of all the GeoTIFF files
</span><span class="n">search_pattern</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">dem_dir</span><span class="p">,</span> <span class="sh">"</span><span class="s">conus_dem_*.tif</span><span class="sh">"</span><span class="p">)</span>
<span class="n">dem_files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">search_pattern</span><span class="p">)</span>

<span class="n">src_files_to_mosaic</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">dem_files</span><span class="p">:</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="n">src_files_to_mosaic</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

<span class="n">mosaic</span><span class="p">,</span> <span class="n">out_trans</span> <span class="o">=</span> <span class="n">merge</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">src_files_to_mosaic</span><span class="p">)</span>

<span class="c1"># Copy the metadata from one of the input files
</span><span class="n">out_meta</span> <span class="o">=</span> <span class="n">src_files_to_mosaic</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
<span class="n">out_meta</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span>
    <span class="sh">"</span><span class="s">driver</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">GTiff</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">height</span><span class="sh">"</span><span class="p">:</span> <span class="n">mosaic</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">width</span><span class="sh">"</span><span class="p">:</span> <span class="n">mosaic</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">transform</span><span class="sh">"</span><span class="p">:</span> <span class="n">out_trans</span>
<span class="p">})</span>

<span class="n">merged_dem_path</span> <span class="o">=</span> <span class="n">dem_dir</span> <span class="o">/</span> <span class="sh">"</span><span class="s">merged_conus_dem.tif</span><span class="sh">"</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">merged_dem_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">,</span> <span class="o">**</span><span class="n">out_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
    <span class="n">dest</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">mosaic</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Merged DEM saved to </span><span class="si">{</span><span class="n">merged_dem_path</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Proportion of missing data in merged DEM: </span><span class="si">{</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">mosaic</span> <span class="o">&lt;</span> <span class="n">config</span><span class="p">.</span><span class="n">dem_nodata_threshold</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">src_files_to_mosaic</span><span class="p">:</span>
    <span class="n">src</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="c1"># Delete variables to save on memory
</span><span class="k">del</span> <span class="n">mosaic</span>


</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[INFO] Merged DEM saved to /mnt/m2ssd/data/Dropbox/research/nlcd-inpaint/generative-land-cover/data/dem/merged_conus_dem.tif
[INFO] Proportion of missing data in merged DEM: 34.07%
</code></pre></div></div> <h4 id="check-merged-file-metadata">Check merged file metadata</h4> <p>Again, paranoia is healthy when working with geospatial data. Let’s confirm the metadata is as we hope it should be.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Print basic information about the merged GeoTIFF file
</span><span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">merged_dem_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">merged_src</span><span class="p">:</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Dataset CRS: </span><span class="si">{</span><span class="n">merged_src</span><span class="p">.</span><span class="n">crs</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Dataset bounds: </span><span class="si">{</span><span class="n">merged_src</span><span class="p">.</span><span class="n">bounds</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Dataset shape: </span><span class="si">{</span><span class="n">merged_src</span><span class="p">.</span><span class="n">shape</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Dataset resolution: </span><span class="si">{</span><span class="n">merged_src</span><span class="p">.</span><span class="n">res</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Dataset transform: </span><span class="si">{</span><span class="n">merged_src</span><span class="p">.</span><span class="n">transform</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Missing data value: </span><span class="si">{</span><span class="n">merged_src</span><span class="p">.</span><span class="n">nodata</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Data type: </span><span class="si">{</span><span class="n">merged_src</span><span class="p">.</span><span class="n">dtypes</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[INFO] Dataset CRS: EPSG:4326
[INFO] Dataset bounds: BoundingBox(left=-119.00013888888888, bottom=22.000138888888905, right=-64.00013888888893, top=49.00013888888889)
[INFO] Dataset shape: (97200, 198000)
[INFO] Dataset resolution: (0.0002777777777777776, 0.0002777777777777776)
[INFO] Dataset transform: | 0.00, 0.00,-119.00|
| 0.00,-0.00, 49.00|
| 0.00, 0.00, 1.00|
[INFO] Missing data value: -32768.0
[INFO] Data type: ('int16',)
</code></pre></div></div> <h4 id="show-merged-file-as-elevation-heatmap">Show merged file as elevation heatmap</h4> <p>A beautiful thing about common Python libraries for geodata like <code class="language-plaintext highlighter-rouge">rasterio</code> is that they often have extremely sensible APIs for windowed or strided reading. Here’s a fast, IO efficient way to quickly create a plottable summary of the merged data by reading every 100-th pixel.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load the image and run imshow
</span><span class="k">if</span> <span class="n">config</span><span class="p">.</span><span class="n">show_plots</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">merged_dem_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">downsample_stride</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">dem_data</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span>
            <span class="n">src</span><span class="p">.</span><span class="n">count</span><span class="p">,</span>
            <span class="nf">int</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">downsample_stride</span><span class="p">),</span>
            <span class="nf">int</span><span class="p">(</span><span class="n">src</span><span class="p">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">downsample_stride</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">resampling</span><span class="o">=</span><span class="n">rasterio</span><span class="p">.</span><span class="n">enums</span><span class="p">.</span><span class="n">Resampling</span><span class="p">.</span><span class="n">nearest</span>
     <span class="p">)</span>

        
        <span class="c1"># Calculate slope
</span>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">gradient</span><span class="p">(</span><span class="n">dem_data</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">src</span><span class="p">.</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">log_slope</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log10</span><span class="p">(</span><span class="n">slope</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Adding 1 to avoid log(0)
</span>        
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
        
        <span class="c1"># Plot elevation
</span>        <span class="n">im1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">dem_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">terrain</span><span class="sh">'</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Merged DEM Data</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Longitude</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Latitude</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">cbar1</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">orientation</span><span class="o">=</span><span class="sh">'</span><span class="s">vertical</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Elevation (meters)</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Plot log10 slope
</span>        <span class="n">im2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">log_slope</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">viridis</span><span class="sh">'</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">'</span><span class="s">Log10 Slope</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Longitude</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Latitude</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">cbar2</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">orientation</span><span class="o">=</span><span class="sh">'</span><span class="s">vertical</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Log10 Slope</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Set the ticks to match the bounds
</span>        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="p">.</span><span class="nc">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">))</span>
            <span class="n">ax</span><span class="p">.</span><span class="n">yaxis</span><span class="p">.</span><span class="nf">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="p">.</span><span class="nc">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">))</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">)</span>
        
    <span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Skipping display of merged DEM data. Set `show_plots` to True to display.</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <p align="center"> <img src="/images/nlcd-dataset/01-preparing-a-dataset_39_0.png" width="65%"> </p> <h1 id="9-join-elevation-data-with-land-cover-data">9. Join elevation data with land cover data</h1> <p>This is an especially delicate step. Just because you have done your best to make sure that the bounding box for the land cover extract and the elevation extract are the same, you may still get bad results due to minor errors in indexing or precision. At this point, some visual assessment of pixel-level accuracy of the coregistration of the two data layers is essential.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">extract_dem_images</span><span class="p">(</span><span class="n">gdf</span><span class="p">:</span> <span class="n">gpd</span><span class="p">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">dem_src</span><span class="p">:</span> <span class="n">rasterio</span><span class="p">.</span><span class="n">DatasetReader</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="p">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">]:</span>
    <span class="n">dem_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nodata_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">interpolate_count</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf</span><span class="p">.</span><span class="nf">iterrows</span><span class="p">():</span>
        
        <span class="n">window</span> <span class="o">=</span> <span class="n">rasterio</span><span class="p">.</span><span class="n">windows</span><span class="p">.</span><span class="nf">from_bounds</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">.</span><span class="n">geometry</span><span class="p">.</span><span class="n">bounds</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">dem_src</span><span class="p">.</span><span class="n">transform</span><span class="p">)</span> 
        
        <span class="n">dem_data</span> <span class="o">=</span> <span class="n">dem_src</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>

        <span class="n">is_nodata</span> <span class="o">=</span> <span class="n">dem_data</span> <span class="o">==</span> <span class="n">dem_src</span><span class="p">.</span><span class="n">nodata</span>
        <span class="n">nodata_fraction</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">is_nodata</span><span class="p">)</span>
        <span class="n">dem_data</span> <span class="o">=</span> <span class="n">dem_data</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># If the read failed, the shape will be empty so we raise an alarm
</span>        <span class="c1"># If any failure cases occur, we want the resulting DEM array to be all NaNs
</span>        <span class="c1"># and have all dims with nonzero size.
</span>        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">dem_data</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dem_data</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">empty</span><span class="p">((</span><span class="n">config</span><span class="p">.</span><span class="n">image_size</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">image_size</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span>
            <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to read window for row </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s"> with window </span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">nodata_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="nf">any</span><span class="p">([</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dem_data</span><span class="p">.</span><span class="n">shape</span><span class="p">]):</span>
            <span class="n">dem_data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">empty</span><span class="p">((</span><span class="n">config</span><span class="p">.</span><span class="n">image_size</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">image_size</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span>
            <span class="n">logging</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Window read for row </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s"> with bbox </span><span class="si">{</span><span class="n">row</span><span class="p">.</span><span class="n">geometry</span><span class="p">.</span><span class="n">bounds</span><span class="si">}</span><span class="s"> has a zero dimension with shape </span><span class="si">{</span><span class="n">dem_data</span><span class="p">.</span><span class="n">shape</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">nodata_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">nodata_fraction</span> <span class="o">&gt;</span> <span class="n">config</span><span class="p">.</span><span class="n">dem_nodata_threshold</span><span class="p">:</span>            
            <span class="n">dem_data</span> <span class="o">*=</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span>
            <span class="n">nodata_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">np</span><span class="p">.</span><span class="nf">any</span><span class="p">(</span><span class="n">is_nodata</span><span class="p">):</span>
            <span class="c1"># Interpolate NaN values using a spatially informed method
</span>            <span class="n">mask</span> <span class="o">=</span> <span class="n">dem_data</span> <span class="o">==</span> <span class="n">dem_src</span><span class="p">.</span><span class="n">nodata</span>
            <span class="n">dem_data</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">inpaint</span><span class="p">(</span><span class="n">dem_data</span><span class="p">,</span> <span class="n">mask</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">inpaintRadius</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">INPAINT_TELEA</span><span class="p">)</span>
            <span class="n">interpolate_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Resize using cv2 to the desired image size
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="p">.</span><span class="nf">any</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">isnan</span><span class="p">(</span><span class="n">dem_data</span><span class="p">)):</span>
            <span class="n">dem_data</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">resize</span><span class="p">(</span><span class="n">dem_data</span><span class="p">,</span> <span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">image_size</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">image_size</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="p">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>

        <span class="n">dem_images</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">dem_data</span><span class="p">)</span>

    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Number of images dropped due to nodata proportion exceeding threshold: </span><span class="si">{</span><span class="n">nodata_count</span><span class="si">}</span><span class="s"> / </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Number of images with interpolation of missing values: </span><span class="si">{</span><span class="n">interpolate_count</span><span class="si">}</span><span class="s"> / </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">dem_images</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>

<span class="k">with</span> <span class="n">rasterio</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">merged_dem_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">dem_src</span><span class="p">:</span>
    <span class="n">train_dem_images</span> <span class="o">=</span> <span class="nf">extract_dem_images</span><span class="p">(</span><span class="n">train_gdf</span><span class="p">,</span> <span class="n">dem_src</span><span class="p">)</span>
    <span class="n">test_dem_images</span> <span class="o">=</span> <span class="nf">extract_dem_images</span><span class="p">(</span><span class="n">test_gdf</span><span class="p">,</span> <span class="n">dem_src</span><span class="p">)</span>

<span class="c1"># Offset all images to have a minimum of zero
</span><span class="n">train_dem_images</span> <span class="o">-=</span> <span class="n">train_dem_images</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">test_dem_images</span> <span class="o">-=</span> <span class="n">test_dem_images</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/mnt/m2ssd/data/Dropbox/research/nlcd-inpaint/.venv/lib/python3.10/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/mnt/m2ssd/data/Dropbox/research/nlcd-inpaint/.venv/lib/python3.10/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/tmp/ipykernel_348578/826475755.py:24: RuntimeWarning: invalid value encountered in multiply
  dem_data = np.empty((config.image_size, config.image_size)) * np.nan
[INFO] Number of images dropped due to nodata proportion exceeding threshold: 422 / 929184
[INFO] Number of images with interpolation of missing values: 0 / 929184
[INFO] Number of images dropped due to nodata proportion exceeding threshold: 142 / 227967
[INFO] Number of images with interpolation of missing values: 0 / 227967
</code></pre></div></div> <h4 id="show-dem-images">Show DEM images</h4> <p>Let’s also make some pretty images of the elevation maps.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot several train and test images using elevation colormap
</span><span class="k">if</span> <span class="n">config</span><span class="p">.</span><span class="n">show_plots</span><span class="p">:</span>
    <span class="n">n_images</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_images</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="c1"># Pick random sample of train and test images to show
</span>    <span class="n">sampled_train_indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">train_dem_images</span><span class="p">),</span> <span class="n">n_images</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">sampled_test_indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">test_dem_images</span><span class="p">),</span> <span class="n">n_images</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n_images</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">gdf</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">sampled_indices</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="nf">zip</span><span class="p">(</span>
                <span class="p">[</span><span class="n">train_dem_images</span><span class="p">,</span> <span class="n">test_dem_images</span><span class="p">],</span> 
                <span class="p">[</span><span class="n">train_gdf</span><span class="p">,</span> <span class="n">test_gdf</span><span class="p">],</span> 
                <span class="p">[</span><span class="sh">"</span><span class="s">Train DEM</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Test DEM</span><span class="sh">"</span><span class="p">],</span>
                <span class="p">[</span><span class="n">sampled_train_indices</span><span class="p">,</span> <span class="n">sampled_test_indices</span><span class="p">])):</span>
            
            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">sampled_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">terrain</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s"> Image </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">centroid</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sampled_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">geometry</span><span class="p">.</span><span class="n">centroid</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">text</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">centroid</span><span class="p">.</span><span class="n">y</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">centroid</span><span class="p">.</span><span class="n">x</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">,</span> 
                          <span class="n">bbox</span><span class="o">=</span><span class="nf">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">white</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="sh">'</span><span class="s">round,pad=0.3</span><span class="sh">'</span><span class="p">))</span>
            <span class="c1"># Add gridlines and lat/long overlay
</span>            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">image_size</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">config</span><span class="p">.</span><span class="n">image_size</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">set_xticklabels</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">centroid</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">config</span><span class="p">.</span><span class="n">image_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">centroid</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">config</span><span class="p">.</span><span class="n">image_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">).</span><span class="nf">round</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">set_yticklabels</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">centroid</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">config</span><span class="p">.</span><span class="n">image_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">centroid</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">config</span><span class="p">.</span><span class="n">image_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">).</span><span class="nf">round</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            
    <span class="c1"># Add a common colorbar on the right-hand side
</span>    <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_axes</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>
    <span class="n">fig</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="sh">'</span><span class="s">vertical</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Elevation (meters)</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Skipping DEM image visualization; set show_plots to True to display images.</span><span class="sh">"</span><span class="p">)</span>

</code></pre></div></div> <p align="center"> <img src="/images/nlcd-dataset/01-preparing-a-dataset_43_1.png" width="65%"> </p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create visualization of NLCD and DEM data
</span><span class="n">n_images</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">seen_classes</span> <span class="o">=</span> <span class="nf">set</span><span class="p">()</span>
<span class="k">if</span> <span class="n">config</span><span class="p">.</span><span class="n">show_plots</span><span class="p">:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_images</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_images</span><span class="o">*</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="c1"># Pick random sample of train images to show
</span>    
    <span class="n">sampled_indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">train_images</span><span class="p">),</span> <span class="n">n_images</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># Plot first n_images from training set
</span>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sample_idx</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">sampled_indices</span><span class="p">):</span>

        <span class="c1"># Get DEM data for this image
</span>        <span class="n">dem</span> <span class="o">=</span> <span class="n">train_dem_images</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
        <span class="n">dem_min</span> <span class="o">=</span> <span class="n">dem</span><span class="p">.</span><span class="nf">min</span><span class="p">()</span>
        <span class="n">dem_relative</span> <span class="o">=</span> <span class="n">dem</span> <span class="o">-</span> <span class="n">dem_min</span>
        
        <span class="c1"># Calculate contours (relative to minimum elevation)
</span>        <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dem_relative</span><span class="p">.</span><span class="nf">max</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span>
        
        <span class="c1"># Plot NLCD with contours
</span>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">lut</span><span class="p">[</span><span class="n">train_images</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]])</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">contour</span><span class="p">(</span><span class="n">dem_relative</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">clabel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="sh">'</span><span class="s">%.0f</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Training Image </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="c1"># Add lat/lon labels to image
</span>        <span class="n">centroid</span> <span class="o">=</span> <span class="n">train_gdf</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">].</span><span class="n">geometry</span><span class="p">.</span><span class="n">centroid</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">text</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">centroid</span><span class="p">.</span><span class="n">y</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">centroid</span><span class="p">.</span><span class="n">x</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">,</span>
                        <span class="n">bbox</span><span class="o">=</span><span class="nf">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">white</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">boxstyle</span><span class="o">=</span><span class="sh">'</span><span class="s">round,pad=0.3</span><span class="sh">'</span><span class="p">))</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">)</span>

        <span class="c1"># Plot DEM
</span>        <span class="n">im</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">terrain</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Elevation Image </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">].</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">seen_classes</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">unique</span><span class="p">(</span><span class="n">train_images</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]))</span>
        
    <span class="c1"># Add colorbar for elevation below the subplots
</span>    <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_axes</span><span class="p">([</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">])</span>
    <span class="n">fig</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="sh">'</span><span class="s">horizontal</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Elevation, relative to minimum (m)</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Add legend for NLCD classes above the subplots
</span>    <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="p">.</span><span class="nc">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">classes_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sh">"</span><span class="s">RGB</span><span class="sh">"</span><span class="p">],</span> 
                                     <span class="n">label</span><span class="o">=</span><span class="n">classes_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">])</span> 
                      <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">seen_classes</span><span class="p">]</span>
    <span class="n">fig</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="sh">'</span><span class="s">upper center</span><span class="sh">'</span><span class="p">,</span> 
               <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Skipping visualization of NLCD and DEM data; set show_plots=True to enable.</span><span class="sh">"</span><span class="p">)</span>

</code></pre></div></div> <p align="center"> <img src="/images/nlcd-dataset/01-preparing-a-dataset_44_1.png" width="65%"> </p> <h1 id="10-concatenate-data-and-save-to-disk">10. Concatenate data and save to disk</h1> <p>Now that we’ve done all the hard work, let’s finally save our data to disk. It is popular to use data packaging formats like hdf5, xarray, and so on. These can be useful, but remember - you need to do everything you can to make it easier for your future self to jump back into the work with short notice. Just be simple and sensible by saving an array in shape <code class="language-plaintext highlighter-rouge">N, C, H, W</code>. You’ll know which channel is which just by looking at the elements.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">is_image_bad_train</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">any</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">isnan</span><span class="p">(</span><span class="n">train_dem_images</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">is_image_kept_train</span> <span class="o">=</span> <span class="o">~</span><span class="n">is_image_bad_train</span>

<span class="n">train_images_final</span> <span class="o">=</span> <span class="n">train_images</span><span class="p">[</span><span class="n">is_image_kept_train</span><span class="p">]</span>
<span class="n">train_dem_images_final</span> <span class="o">=</span> <span class="n">train_dem_images</span><span class="p">[</span><span class="n">is_image_kept_train</span><span class="p">]</span>
<span class="n">train_gdf_final</span> <span class="o">=</span> <span class="n">train_gdf</span><span class="p">[</span><span class="n">is_image_kept_train</span><span class="p">]</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Removed </span><span class="si">{</span><span class="n">is_image_bad_train</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span><span class="si">}</span><span class="s"> images with missing DEM data from training set.</span><span class="sh">"</span><span class="p">)</span>

<span class="n">is_image_bad_test</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">any</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">isnan</span><span class="p">(</span><span class="n">test_dem_images</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">is_image_kept_test</span> <span class="o">=</span> <span class="o">~</span><span class="n">is_image_bad_test</span>
<span class="n">test_images_final</span> <span class="o">=</span> <span class="n">test_images</span><span class="p">[</span><span class="n">is_image_kept_test</span><span class="p">]</span>
<span class="n">test_dem_images_final</span> <span class="o">=</span> <span class="n">test_dem_images</span><span class="p">[</span><span class="n">is_image_kept_test</span><span class="p">]</span>
<span class="n">test_gdf_final</span> <span class="o">=</span> <span class="n">test_gdf</span><span class="p">[</span><span class="n">is_image_kept_test</span><span class="p">]</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Removed </span><span class="si">{</span><span class="n">is_image_bad_test</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span><span class="si">}</span><span class="s"> images with missing DEM data from test set.</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Take arrays of shape (N, H, W) and stack them along the channel axis
# which needs to be created for both data sets
</span><span class="n">train_combined</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">stack</span><span class="p">([</span><span class="n">train_images_final</span><span class="p">,</span> <span class="n">train_dem_images_final</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">np</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">output_path_train</span><span class="p">,</span> <span class="n">train_combined</span><span class="p">)</span>
<span class="n">train_file_size</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getsize</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">output_path_train</span><span class="p">)</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Training Numpy array with shape </span><span class="si">{</span><span class="n">train_combined</span><span class="p">.</span><span class="n">shape</span><span class="si">}</span><span class="s"> saved to </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">output_path_train</span><span class="si">}</span><span class="s"> (Size: </span><span class="si">{</span><span class="n">train_file_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> MB)</span><span class="sh">"</span><span class="p">)</span>

<span class="n">test_combined</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">stack</span><span class="p">([</span><span class="n">test_images_final</span><span class="p">,</span> <span class="n">test_dem_images_final</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">np</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">output_path_test</span><span class="p">,</span> <span class="n">test_combined</span><span class="p">)</span>
<span class="n">test_file_size</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getsize</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">output_path_test</span><span class="p">)</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Test data Numpy array with shape </span><span class="si">{</span><span class="n">test_combined</span><span class="p">.</span><span class="n">shape</span><span class="si">}</span><span class="s"> saved to </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">output_path_test</span><span class="si">}</span><span class="s"> (Size: </span><span class="si">{</span><span class="n">test_file_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> MB)</span><span class="sh">"</span><span class="p">)</span>

<span class="n">train_gdf_final</span><span class="p">.</span><span class="nf">to_file</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">output_path_train</span><span class="p">.</span><span class="nf">with_suffix</span><span class="p">(</span><span class="sh">'</span><span class="s">.gpkg</span><span class="sh">'</span><span class="p">),</span> <span class="n">driver</span><span class="o">=</span><span class="sh">'</span><span class="s">GPKG</span><span class="sh">'</span><span class="p">)</span>
<span class="n">train_gpkg_size</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getsize</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">output_path_train</span><span class="p">.</span><span class="nf">with_suffix</span><span class="p">(</span><span class="sh">'</span><span class="s">.gpkg</span><span class="sh">'</span><span class="p">))</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Training sample location GeoDataFrame saved to </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">output_path_train</span><span class="p">.</span><span class="nf">with_suffix</span><span class="p">(</span><span class="sh">'</span><span class="s">.gpkg</span><span class="sh">'</span><span class="p">)</span><span class="si">}</span><span class="s"> (Size: </span><span class="si">{</span><span class="n">train_gpkg_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> MB)</span><span class="sh">"</span><span class="p">)</span>

<span class="n">test_gdf_final</span><span class="p">.</span><span class="nf">to_file</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">output_path_test</span><span class="p">.</span><span class="nf">with_suffix</span><span class="p">(</span><span class="sh">'</span><span class="s">.gpkg</span><span class="sh">'</span><span class="p">),</span> <span class="n">driver</span><span class="o">=</span><span class="sh">'</span><span class="s">GPKG</span><span class="sh">'</span><span class="p">)</span>
<span class="n">test_gpkg_size</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">getsize</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">output_path_test</span><span class="p">.</span><span class="nf">with_suffix</span><span class="p">(</span><span class="sh">'</span><span class="s">.gpkg</span><span class="sh">'</span><span class="p">))</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Test sample location GeoDataFrame saved to </span><span class="si">{</span><span class="n">config</span><span class="p">.</span><span class="n">output_path_test</span><span class="p">.</span><span class="nf">with_suffix</span><span class="p">(</span><span class="sh">'</span><span class="s">.gpkg</span><span class="sh">'</span><span class="p">)</span><span class="si">}</span><span class="s"> (Size: </span><span class="si">{</span><span class="n">test_gpkg_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> MB)</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[INFO] Removed 422 images with missing DEM data from training set.
[INFO] Removed 142 images with missing DEM data from test set.
[INFO] Training Numpy array with shape (928762, 2, 40, 40) saved to /mnt/m2ssd/data/Dropbox/research/nlcd-inpaint/generative-land-cover/data/train.npy (Size: 22674.85 MB)
[INFO] Test data Numpy array with shape (227825, 2, 40, 40) saved to /mnt/m2ssd/data/Dropbox/research/nlcd-inpaint/generative-land-cover/data/test.npy (Size: 5562.13 MB)
[INFO] Training sample location GeoDataFrame saved to /mnt/m2ssd/data/Dropbox/research/nlcd-inpaint/generative-land-cover/data/train.gpkg (Size: 185.46 MB)
[INFO] Test sample location GeoDataFrame saved to /mnt/m2ssd/data/Dropbox/research/nlcd-inpaint/generative-land-cover/data/test.gpkg (Size: 45.86 MB)
</code></pre></div></div> <h1 id="11-make-an-animation">11. Make an animation</h1> <p>Cleaning and processing data is pure drudgery and I am sorry that you have to do it. Hopefully in ten years we will have a better solution than doing it ourselves.</p> <p>The best way you can make it palatable is to make something pretty. Make something that gives you joy when you look at it, because joy is rare here. Through much trial and error, I’ve found that (besides high-impact publications), what makes colleagues the happiest is a nice animation that gives them something to think about.</p> <p>Always try to give your peers some eye candy.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">from</span> <span class="n">matplotlib.animation</span> <span class="kn">import</span> <span class="n">FuncAnimation</span>
<span class="kn">import</span> <span class="n">matplotlib</span> <span class="k">as</span> <span class="n">mpl</span>
<span class="kn">from</span> <span class="n">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">from</span> <span class="n">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="k">class</span> <span class="nc">TerrainAnimator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">train_images</span><span class="p">,</span> <span class="n">train_dem_images</span><span class="p">,</span> <span class="n">lut</span><span class="p">,</span> <span class="n">n_rows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_cols</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">train_images</span> <span class="o">=</span> <span class="n">train_images</span>
        <span class="n">self</span><span class="p">.</span><span class="n">train_dem_images</span> <span class="o">=</span> <span class="n">train_dem_images</span>
        <span class="n">self</span><span class="p">.</span><span class="n">lut</span> <span class="o">=</span> <span class="n">lut</span>
        <span class="n">self</span><span class="p">.</span><span class="n">n_rows</span> <span class="o">=</span> <span class="n">n_rows</span>
        <span class="n">self</span><span class="p">.</span><span class="n">n_cols</span> <span class="o">=</span> <span class="n">n_cols</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exaggeration</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="c1"># Pre-calculate mesh grid
</span>        <span class="n">self</span><span class="p">.</span><span class="n">h</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">train_images</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">shape</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">w</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">h</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        
        <span class="c1"># Initialize figure
</span>        <span class="n">self</span><span class="p">.</span><span class="nf">setup_figure</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">setup_figure</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="sh">'</span><span class="s">figure.dpi</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">150</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fig</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span>
            <span class="n">self</span><span class="p">.</span><span class="n">n_rows</span><span class="p">,</span> 
            <span class="n">self</span><span class="p">.</span><span class="n">n_cols</span><span class="p">,</span> 
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">n_cols</span><span class="o">*</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">n_rows</span><span class="o">*</span><span class="mf">1.6</span><span class="p">),</span>  <span class="c1"># Reduced figure size
</span>            <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">projection</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">3d</span><span class="sh">'</span><span class="p">},</span>
            <span class="n">constrained_layout</span><span class="o">=</span><span class="bp">True</span>  <span class="c1"># Use constrained layout
</span>        <span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fig</span><span class="p">.</span><span class="nf">set_facecolor</span><span class="p">(</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fig</span><span class="p">.</span><span class="n">patch</span><span class="p">.</span><span class="nf">set_alpha</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="c1"># Reduce margins
</span>        <span class="n">plt</span><span class="p">.</span><span class="nf">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>
        
        <span class="c1"># Select random indices once
</span>        <span class="n">self</span><span class="p">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span>
            <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">train_images</span><span class="p">),</span> 
            <span class="n">self</span><span class="p">.</span><span class="n">n_rows</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">n_cols</span><span class="p">,</span> 
            <span class="n">replace</span><span class="o">=</span><span class="bp">False</span>
        <span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">process_elevation</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">elevation</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Pre-process elevation data with Gaussian smoothing</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="p">.</span><span class="nc">GaussianBlur</span><span class="p">(</span><span class="n">elevation</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">create_surface</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Create a single surface plot</span><span class="sh">"""</span>
        <span class="n">land_cover</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">train_images</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">elevation</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">process_elevation</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">train_dem_images</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        
        <span class="n">surf</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">plot_surface</span><span class="p">(</span>
            <span class="n">self</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span>
            <span class="n">elevation</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">exaggeration</span><span class="p">,</span>
            <span class="n">facecolors</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">lut</span><span class="p">[</span><span class="n">land_cover</span><span class="p">],</span>
            <span class="n">shade</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">antialiased</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">rstride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">cstride</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        
        <span class="c1"># Configure view
</span>        <span class="n">ax</span><span class="p">.</span><span class="nf">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">.</span><span class="nf">set_box_aspect</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
        
        <span class="c1"># Remove unnecessary elements
</span>        <span class="n">ax</span><span class="p">.</span><span class="nf">set_xticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="p">.</span><span class="nf">set_yticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="p">.</span><span class="nf">set_zticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">.</span><span class="nf">axis</span><span class="p">(</span><span class="sh">'</span><span class="s">off</span><span class="sh">'</span><span class="p">)</span>

        <span class="n">ele_max</span> <span class="o">=</span> <span class="n">elevation</span><span class="p">.</span><span class="nf">max</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ele_max</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">zlim</span> <span class="o">=</span> <span class="mi">150</span>
        <span class="k">elif</span> <span class="n">ele_max</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">zlim</span> <span class="o">=</span> <span class="mi">250</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zlim</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="n">ele_max</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">.</span><span class="nf">set_zlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">zlim</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">surf</span>
        
    <span class="k">def</span> <span class="nf">setup_plots</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Initialize all surface plots in parallel</span><span class="sh">"""</span>
        <span class="k">with</span> <span class="nc">ThreadPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">surfaces</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">executor</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">args</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="nf">create_surface</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">),</span>
                <span class="nf">zip</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">axes</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(),</span> <span class="n">self</span><span class="p">.</span><span class="n">indices</span><span class="p">)</span>
            <span class="p">))</span>
        
        <span class="n">plt</span><span class="p">.</span><span class="nf">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=-</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=-</span><span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># Increased overlap between subplots
</span>        
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Animation update function</span><span class="sh">"""</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">axes</span><span class="p">.</span><span class="nf">flatten</span><span class="p">():</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">surfaces</span>
        
    <span class="k">def</span> <span class="nf">create_animation</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="mi">360</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Create and save the animation</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">setup_plots</span><span class="p">()</span>
        
        <span class="n">anim</span> <span class="o">=</span> <span class="nc">FuncAnimation</span><span class="p">(</span>
            <span class="n">self</span><span class="p">.</span><span class="n">fig</span><span class="p">,</span>
            <span class="n">self</span><span class="p">.</span><span class="n">update</span><span class="p">,</span>
            <span class="n">frames</span><span class="o">=</span><span class="n">frames</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="mi">1000</span><span class="o">/</span><span class="n">fps</span><span class="p">,</span>
            <span class="n">blit</span><span class="o">=</span><span class="bp">True</span>
        <span class="p">)</span>
        
        <span class="c1"># Save with optimized settings
</span>        <span class="n">anim</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span>
            <span class="sh">'</span><span class="s">terrain_rotation.gif</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">writer</span><span class="o">=</span><span class="sh">'</span><span class="s">pillow</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span>
            <span class="n">savefig_kwargs</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">facecolor</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">},</span>
            <span class="n">progress_callback</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Saving frame </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="sh">'</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sh">'</span><span class="se">\r</span><span class="sh">'</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>


<span class="n">train_images_final</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">output_path_train</span><span class="p">)</span>
<span class="n">anim_images_lc</span> <span class="o">=</span> <span class="n">train_images_final</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">anim_images_dem</span> <span class="o">=</span> <span class="n">train_images_final</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Usage
</span><span class="n">animator</span> <span class="o">=</span> <span class="nc">TerrainAnimator</span><span class="p">(</span><span class="n">anim_images_lc</span><span class="p">,</span> <span class="n">anim_images_dem</span><span class="p">,</span> <span class="n">lut</span><span class="p">)</span>
<span class="n">animator</span><span class="p">.</span><span class="nf">create_animation</span><span class="p">()</span>
</code></pre></div></div> <p>With this code, we get some nice visualizations of our data samples, rotating and shown in 3D!</p> <p align="center"> <img src="/images/nlcd-dataset/terrain_rotation.gif" width="800" align="center"> </p> <h1 id="epilogue-optimization">Epilogue: optimization</h1> <p>Once you have your code running for a small test dataset, you can go back and try to figure out how to improve it. Runtime is important, but the bigger issue (in my experience) is space in memory as you can always just let a job run longer. You can’t easily give your computer more working memory on the spot. For this, I strongly recommend a command like <code class="language-plaintext highlighter-rouge">%whos</code> to get a dataframe of variables and their size in memory. Sort it if you like, but focus on the ones with the biggest footprint.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span><span class="n">whos</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Variable                     Type              Data/Info
--------------------------------------------------------
...                          ...               ...
x                            ndarray           972x1980: 1924560 elems, type `float64`, 15396480 bytes (14.6832275390625 Mb)
x_edges                      ndarray           51: 51 elems, type `float64`, 408 bytes
y                            ndarray           972x1980: 1924560 elems, type `float64`, 15396480 bytes (14.6832275390625 Mb)
y_edges                      ndarray           51: 51 elems, type `float64`, 408 bytes
</code></pre></div></div> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/why-dont-we-just-freeze-the-carbon/">Solving climate change by abusing thermodynamic scaling laws</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/clustering-for-prob-preterm-birth/">Modeling spatial structure in binary data with an H3 hexagonal coordinate system</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/density-estimation-for-geospatial-imagery-using-autoregressive-models/">Density estimation for geospatial imagery using autoregressive neural models</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/creating-an-emulator-for-an-agent-based-model/">Surrogate modeling for SEIR dynamics</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/nonparametric-changepoint-model-pymc/">Modeling temporal data with an unknown number of changepoints</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Christopher Krapu. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?601a2d3465e2a52bec38b600518d5f70"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let theme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===theme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=document.querySelector(".navbar-collapse");e.classList.contains("show")&&e.classList.remove("show"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"about",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-posts",title:"posts",description:"",section:"Navigation",handler:()=>{window.location.href="/blog/"}},{id:"post-to-my-junior-collaborators-this-is-how-i-want-you-to-write-your-research-code",title:"To my junior collaborators, this is how I want you to write your research code",description:"Opinionated commentary on making a data cleaning script for research",section:"Posts",handler:()=>{window.location.href="/blog/2025/preparing-a-dataset/"}},{id:"post-solving-climate-change-by-abusing-thermodynamic-scaling-laws",title:"Solving climate change by abusing thermodynamic scaling laws",description:"A wintertime climate change solution",section:"Posts",handler:()=>{window.location.href="/blog/2024/why-dont-we-just-freeze-the-carbon/"}},{id:"post-modeling-temporal-data-with-an-unknown-number-of-changepoints",title:"Modeling temporal data with an unknown number of changepoints",description:"A nonparametric changepoint model in PyMC",section:"Posts",handler:()=>{window.location.href="/blog/2022/nonparametric-changepoint-model-pymc/"}},{id:"post-distributed-zonal-averages-for-fast-geospatial-analyses",title:"Distributed zonal averages for fast geospatial analyses",description:"Easy local average with Google Earth Engine&#39;s Python API",section:"Posts",handler:()=>{window.location.href="/blog/2022/fast-local-summary-earth-engine/"}},{id:"post-fast-kronecker-matrix-vector-product-with-einsum",title:"Fast Kronecker matrix-vector product with einsum",description:"Easy local average with Google Earth Engine&#39;s Python API",section:"Posts",handler:()=>{window.location.href="/blog/2021/fast-matrix-vector-product-for-structured-matrices/"}},{id:"post-balanced-spatial-partitioning-for-point-data-in-20-lines",title:"Balanced spatial partitioning for point data in 20 lines",description:"Recursively splitting by boxes",section:"Posts",handler:()=>{window.location.href="/blog/2021/balanced-spatial-partitioning-for-point-data-in-20-lines/"}},{id:"post-modeling-spatial-structure-in-binary-data-with-an-h3-hexagonal-coordinate-system",title:"Modeling spatial structure in binary data with an H3 hexagonal coordinate system",description:"Conditional autoregression for 6-adjacent data",section:"Posts",handler:()=>{window.location.href="/blog/2021/clustering-for-prob-preterm-birth/"}},{id:"post-surrogate-modeling-for-seir-dynamics",title:"Surrogate modeling for SEIR dynamics",description:"Modeling a model, for epidemiology",section:"Posts",handler:()=>{window.location.href="/blog/2021/creating-an-emulator-for-an-agent-based-model/"}},{id:"post-density-estimation-for-geospatial-imagery-using-autoregressive-neural-models",title:"Density estimation for geospatial imagery using autoregressive neural models",description:"Conditional autoregression for 6-adjacent data",section:"Posts",handler:()=>{window.location.href="/blog/2020/density-estimation-for-geospatial-imagery-using-autoregressive-models/"}},{id:"post-multivariate-sample-size-for-markov-chains",title:"Multivariate sample size for Markov chains",description:"Assessing effective sample size for multiple variates",section:"Posts",handler:()=>{window.location.href="/blog/2020/multivariate-sample-size-for-markov-chains/"}},{id:"socials-email",title:"Send email",section:"Socials",handler:()=>{window.open("mailto:%63%6B%72%61%70%75@%67%6D%61%69%6C.%63%6F%6D","_blank")}},{id:"socials-github",title:"GitHub",section:"Socials",handler:()=>{window.open("https://github.com/ckrapu","_blank")}},{id:"socials-rss",title:"RSS Feed",section:"Socials",handler:()=>{window.open("/feed.xml","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> </body> </html>